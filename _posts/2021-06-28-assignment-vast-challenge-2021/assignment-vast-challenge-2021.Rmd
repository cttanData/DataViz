---
title: "Assignment - VAST Challenge 2021"
description: |
  [VAST Challenge 2021](https://vast-challenge.github.io/2021/). Applying visual analytics to gain Insight.....  
author:
  - name: Choo T Tan
    url: {}
date: 06-28-2021
output:
  distill::distill_article:
    self_contained: false
    toc: true
    toc_depth: 2
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE,warning = FALSE,  
                      fig.retina = 3, layout="l-body",
                      fig.height = 8*0.618, fig.width=8, 
                      fig.align='centre')
```

```{r echo = FALSE, warning = FALSE}
packages <- c('tidyverse', 'igraph', 'plotly', 'ggiraph',
              'ggraph','tmap', 'tidygraph',
              'visNetwork') # 'lubridate', 'clock',
for (p in packages){
  if(!require(p, character.only = T)){
    install.packages(p)
  }
  library(p,character.only = T)
}
rm(p)
```

# 1.0 Introduction 
The assignment is based on [VAST Challenge 2021](https://vast-challenge.github.io/2021/) where it has selected solve the [Mini Challenges 2 (MC2)](https://vast-challenge.github.io/2021/MC2.html) out of the 3 mini challenges via visual analytics out. The fictitious scenario was based on a Tethys-based natural gas production company GAStech in the country of Kronos where it has made remarkable profits and strong relationship with the government. However, GAStech has not been as successful in demonstrating environmental stewardship. Several employee went missing in January 2014 after a successful initial public offering. It was suspected that the disappearance might be associated with an organization known as the Protectors of Kronos (POK). However, things may not be so simplicity. Thus, one has been tasked to assist the law enforcement from Kronos and Tethys in solving the assigned task via visual analytics. 

# 2.0 Requirements 
The main task is to identify suspicious patterns of behavior from the transaction done by GASTech employees. You must cope with uncertainties that result from missing, conflicting, and imperfect data to make recommendations for further investigation. There are 4 main CSV files with 15 Korons geospatial data in tif or shp etc. [here](https://vast-challenge.github.io/2021/MC2.html) The data is based on last 14 days, 6 - 19 January 2014 prior to the disappearance. __As part of assignment constraint, only libraries from R programming languages can be used to complete the analytics.__ The CSV files are namely (1) credit card transaction, (2) loyalty card transaction, (3) geospatial tracking data for company cars which not know to employee, (4) car assignment. The relevant questions to be answered are: 

1. Using just the credit and loyalty card data, identify the most popular locations, and when they are popular. What anomalies do you see? What corrections would you recommend to correct these anomalies? Please limit your answer to 8 images and 300 words.

2. Add the vehicle data to your analysis of the credit and loyalty card data. How does your assessment of the anomalies in question 1 change based on this new data? What discrepancies between vehicle, credit, and loyalty card data do you find? Please limit your answer to 8 images and 500 words.

3. Can you infer the owners of each credit card and loyalty card? What is your evidence? Where are there uncertainties in your method? Where are there uncertainties in the data? Please limit your answer to 8 images and 500 words.

4. Given the data sources provided, identify potential informal or unofficial relationships among GASTech personnel. Provide evidence for these relationships. Please limit your response to 8 images and 500 words.

5. Do you see evidence of suspicious activity? Identify 1- 10 locations where you believe the suspicious activity is occurring, and why Please limit your response to 10 images and 500 words.

# 3.0 Liteature Review and Approach


The investigation will be done in 3 main steps:

1. **Data Preparation**. Require data cleaning and transformation to aid the data exploratory. Main focus in to establish the required data point to link up the 3 main files associated with geospatial tracking, credit and loyalty cards transactions. 

2. **Exploratory Data Analysis (EDA)**.  Explain the various R library that would use to build visualisation tool to aid the EDA to discover the required insights for the questions.

3. **Exploration Sharing**. Story telling on the discerned insights.

# 4.0 Date Preparation.
## 4.1 Credit and Loyalty Cards.
For credit and loyalty cards csv files, its contained transaction timestamp, location, price and card number. The timestamp within the files was in different formation eg %m/%d/%Y vs %m/%d/%y etc and credit card came with transacted date and time as compared loyalty only have date. Perform required data wrangling based on observation to resolve the datetime format (i.e. using lubridate and clock) and set card numbers as character. In addition, create date (i.e. Date, rename timestamp in loyalty card to date), weekday and hour for subsequent EDA. Code chuck and glimpse of prepared credit card dataset:

```{r clean up credit}
credit <- read_csv("data/aspatial/cc_data.csv")

#cleaning up on datetime format, since there is %y vs %Y.
credit <- credit %>% # separate them into fine entity
  separate(timestamp, into = c("date","time"), sep=" ",remove = TRUE) %>%
  separate(time, into = c("hr", "min"), sep=":",remove = TRUE) %>%
  separate(date, into = c("mth", "day", "yr"), sep="/",remove = TRUE) %>%
  mutate(yr=2014)

# convert to numeric since make_datetime need numeric format
pack <- c('yr','mth','day','hr','min') 
for (p in pack){
  credit <- credit %>% mutate_at(c(p),as.numeric)
}

credit  <- credit %>% 
  mutate(timestamp = lubridate::make_datetime(yr,mth,day,hr,min)) %>%
  mutate(date = lubridate::make_date(yr,mth,day)) %>%
  dplyr::select(-yr,-mth,-min) %>%
  relocate(timestamp, date, .before=day) %>%
  arrange(last4ccnum, timestamp)

credit$wkday <- lubridate::wday(credit$timestamp, label= TRUE, abbr = FALSE)
credit$last4ccnum = as.character(credit$last4ccnum)
rm(p,pack)
glimpse(credit)
```

A much more simplify code of the above mentioned was used to prepare the loyalty card data set. 

```{r, clean up loyalty card}

loyalty <- read_csv("data/aspatial/loyalty_data.csv")

loyalty<-loyalty %>% 
  separate(timestamp, into = c("mth", "day", "yr"), sep="/",
           remove = TRUE) %>%
  mutate(yr=2014)

pack <- c('yr','mth','day')
for (p in pack){
  loyalty  <- loyalty %>% mutate_at(c(p),as.numeric)
}

loyalty  <- loyalty %>% 
  mutate(date = lubridate::make_date(yr,mth,day)) %>%
  dplyr::select(-yr,-mth) %>%
  arrange(loyaltynum)
rm(p,pack)
```
 
## 4.2 Geospatial Tracking. 
As previous, necessary conversion of Timestamp and id variables to the proper data type. To ease the mapping of location to geospatial values, decided to round off its value to four decimal places. The main focus was to determine the trip within the geospatial tracking dataset for respective vehicle ID. Trip was defined as a continues traveling from point A to B with time lag less than 300secs. 300 secs was arbitrary decided based on screening through the data set. With the trip formed, one could determine the traveling locations for respective veh ID overtimes.  

Code chuck for determine the trip within the days for respective vehicle ID.

```{r, Determine Veh Trip, eval=FALSE}
gps <- read_csv("data/aspatial/gps.csv")

#covert to appropriate datetype for timestamp
gps$Timestamp <- clock::date_time_parse(gps$Timestamp,zone ="",
                                 format = "%m/%d/%Y %H:%M:%S")
gps$id <- as.character(gps$id)

gps <- gps %>% #compute time difference & rd off GPS 
  arrange(id, Timestamp) %>%
  mutate(diff = (Timestamp - lag(Timestamp, default = first(Timestamp)))) %>%
  mutate(rlat = round(lat, digits = 4), rlong = round(long, digits=4))

# initialisation the veh ID
pack <- c( "1", "2","3","4","5","6","7","8","9","10",
           "11","12","13","14","15","16","17","18","19","20",
           "21", "22", "23", "24", "25", "26", "27", "28", "29", "30",
           "31", "32", "33", "34", "35", "101", "104", "105", "106","107")

trip_lag = 300 # interval <= 5mins considered as a single trip

for (p in pack){
  temp <- gps %>% filter(id==p) %>%
    arrange(id, Timestamp) 
  count = 1
  
  for(i in 1:nrow(temp)){
    if(temp[i,'diff']<=trip_lag){
      temp[i,'trip']=count
    }else{
      count = count + 1
      temp[i,'trip'] = count
     }
  } 
  if(p==1){mgps <- temp
  }else{
    cgps = merge(mgps, temp, all.x=T, all.y=T)  
  }
}
cgps <-  cgps %>% arrange(id, Timestamp) #clean GPS data
write.csv(cgps, "data/aspatial/fulltrip_gps.csv", row.names  = FALSE)
rm(temp, gps)
```

```{r, echo=FALSE}
cgps <- read_csv("data/aspatial/fulltrip_gps.csv")
cgps$id = as.character(cgps$id)
cgps$trip = as.character(cgps$trip)
```

Code chuck for conversion to sf dataframe for display in tmap.

```{r}
bgmap<- raster::raster("data/geospatial/MC2-tourist_modified.tif")

gps_sf <- sf::st_as_sf(cgps, coords = c("long","lat"), crs = 4326)

gps_lines <- gps_sf %>% 
  group_by(id, trip) %>%
  summarize(m = mean(Timestamp), do_union=FALSE) %>%
  sf::st_cast("MULTILINESTRING")
```

```{r, echo=FALSE}
gps_points <- gps_sf %>% 
  group_by(id) %>%
  summarize(m = mean(Timestamp), do_union=FALSE) %>%
  sf::st_cast("POINT")
```

Code chuck for plotting a trip for example Veh ID 3.

```{r}

gps_lines_s <- gps_lines %>%
  filter(id==3, trip==6)

tmap_mode("plot")
tm_shape(bgmap) +
  tm_rgb(bgmap, r = 1,g = 2,b = 3,
       alpha = NA,
       saturation = 1,
       interpolate = TRUE,
       max.value = 255) +
  tm_shape(gps_lines_s) +
  tm_lines(col = "navy", lwd=2, alpah=0.7) +
  tm_layout(main.title = "Vehicle ID 3 Trip 6 Geospatial Tracking Data.",
            main.title.position = "center",
            main.title.size = 1)

```
```{r eval=FALSE,echo = FALSE}
gps_points_s <- gps_points %>% 
   filter(id==5, trip==2)

tmap_mode("plot")
tm_shape(bgmap) +
  tm_rgb(bgmap, r =1,g = 2,b =3,
         alpha = NA,
         saturation = 1,
         interpolate = TRUE,
         max.value = 255) +
  tm_shape(gps_points_s) + 
  tm_facets(by="id",free.coords = FALSE) +
  tm_dots("navy", size = .05)
  tm_layout(panel.label.rot = c(0, 90), panel.label.size = 2)
```

# 5.0 Exploratory Data Analysis
## 5.1 Credit and Loyalty Card Data Set

Reference to the company employee records in challenge 1, GASTech has 54 staffs. However, unique count on the credit and loyalty card numbers has shown 55 and 54 count respectively. Its alluded that one of the staff could have 2 credit cards. Moreover,a unique count on the number of transacted locations for each data set has shown that there were 34 and 33  unique locations for credit and loyalty card respectively. The additional location in credit card data set Daily Dealz with a transaction amount 2.01.

To merge both data sets, would determine the common set via inner join operations based on date, location and price. It observed that inner join has 1087 observations, while anti join has 409 and 311 disjoint for credit and loyalty card transaction respectively. The inner join has created 6 extra observations (1392 data points from loyalty - anti join 311 = 1081 or 1490 data points from credit - anti join 409 = 1081). The duplicated observations were identified, deleted and would explain below. It also validated that the inner join contained the full set of credit and loyalty cards numbers and thus would be used to determine the unique pairing of credit to loyalty card. In addition, it also discerned that the inner join did not contain Kronos Mart and Daily Dealz as the transaction location. This implied that transactions at these two locations likely done by either of the card only.  

Code chuck for inner join and finding distinct pair.

```{r, inner join Credit and Loyalty to determine relationship}
dijoin <- credit %>%
  inner_join(loyalty,by=c('date','location','price','day'))

#compute of distinct pairing, X1-Y1, X1-Y2, X2Y3 etc  
dijoin <- dijoin %>% 
  group_by(last4ccnum) %>%
  mutate(ndist = n_distinct(loyaltynum)) %>%
  ungroup() %>%
  group_by(loyaltynum) %>%
  mutate(ndist = if_else(ndist==1,n_distinct(last4ccnum), ndist)) %>%
  relocate(wkday, .before=location) %>%
  ungroup()
```

To determine the pairing, would need to determine the number of distinct count between a credit-loyalty pair based on a fixed credit card number. i.e. X1-Y1, X2-Y2 etc. Logically, there should only be one distinct pairing between both cards assuming a holder has each card.  However,it was discerned that some credit cards has more than a distinct pair. eg X1-Y1, X1-Y2 . This could be due to the fact that the credit card holder has more than one loyalty card or vice verse. To visualise the relationship, would use igraph to built a bipartite graph with nodes as credit and loyalty cards, edges as transaction. Edge weight was based on number of transactions for each distinct credit-loyalty pair. To minimise cluttering so to discover the credit card with more than a distinct pair, the data set would be filtered for distinct pairing count >=2 before group by via both cards. Inking was done on the igraph output, the code chuck and bipartite graph were shown below.

```{r}
#forming the bipartite graph
bigraph <- dijoin %>% # filter out unique pairing and count
  filter(ndist >= 2)%>%
  group_by(last4ccnum,loyaltynum) %>%
  summarise(weights=n()) %>%
  mutate_at(c("weights"), as.numeric)%>%
  arrange(loyaltynum) %>%
  ungroup()

#covert to igraph dataframe, inking and plot bipartite graph
bg<- graph.data.frame(bigraph, directed = TRUE)
V(bg)$type <- bipartite_mapping(bg)$type # assign vertex or nodes,

shape <- c("circle", "square")
E(bg)$color[E(bg)$weights<=5] <- 'red'
E(bg)$color[E(bg)$weights>5] <- 'sky blue'

plot(bg, layout=layout.bipartite, 
     vertex.color=c("orange","pink")[V(bg)$type+1],
     vertex.size=20, vertex.label.cex=0.8,
     vertex.shape = shape[V(bg)$type+1],
     edge.width = E(bg)$weights*0.8,
     edge.label=E(bg)$weights, edge.label.cex=0.7,
     edge.label.color ="black", legend=TRUE)
```

From the bipartite graph, L6267 was used by both credit cards 6691 and 6899. That could account for the short of one loyalty card as in Section 4. There should be some form of relationship between credit card 1286 and 9241 holders given the high usage of the latter loyalty card by the former. Nonetheless, 1283 will be tagged to L3572. For weight equal to 1, it was discovered that this was due to due to duplication of extra observations having similar values defined for the inner join operation. From the chart, it was clear that it was a duplication and not a one time usages. Thus, the duplication would be removed from the data set. Moving on, credit card would be used as the anchoring point for exploration where its pairing to loyalty card would be based on the established relationship here. The established pairing was saved in a csv file for future usage.

```{r echo=FALSE}
ijoin <- dijoin %>%
  filter(!(last4ccnum == "4795" & loyaltynum == "L2070" )) %>%
  filter(!(last4ccnum == "8332" & loyaltynum == "L8566" )) %>%
  filter(!(last4ccnum == "5368" & loyaltynum == "L6119" )) %>%
  filter(!(last4ccnum == "7889" & loyaltynum == "L2247" )) %>%
  filter(!(last4ccnum == "5921" & loyaltynum == "L9406" )) %>%
  filter(!(last4ccnum == "4948" & loyaltynum == "L3295" ))

mapping <- ijoin %>%
  count(last4ccnum,loyaltynum) %>%
  arrange(last4ccnum) %>%
  dplyr::select(-n) 
write.csv(mapping, "data/mapping_tmp.csv")
rm(mapping, dijoin, bg, bigraph)
```

```{r, forming the full file for credit and loyalty, warning= FALSE,echo = FALSE} 
# load the mapping of relationship generate the relationship link
mapping <- read_csv("data/aspatial/mapping.csv")
mapping$tmpC <- as.character(mapping$tmpC)
mapping$tmpL <- as.character(mapping$tmpL)
mapping$VehID <- as.character(mapping$VehID)
```

The full data set for both cards was created using full join on both data sets, removing the duplicate observations determined above. Then mapping of credit cards to the loyalty card was done in full data set.(inclusive of transaction via loyalty card only) In additional, create additional columns like cardtype (transaction with both cards or credit or loyalty card only) to support downstream visualisation. The code chuck and glimpse of the data set was given below. 

```{r,final credit-loyalty dataset } 
fjoin <- credit %>%
  full_join(loyalty,by=c('date','location','price','day')) %>%
  filter(!(last4ccnum == "4795" & loyaltynum == "L2070" 
           & !is.na(last4ccnum) & !is.na(loyaltynum))) %>%
  filter(!(last4ccnum == "8332" & loyaltynum == "L8566" 
           & !is.na(last4ccnum) & !is.na(loyaltynum))) %>%
  filter(!(last4ccnum == "5368" & loyaltynum == "L6119" 
           & !is.na(last4ccnum) & !is.na(loyaltynum))) %>%
  filter(!(last4ccnum == "7889" & loyaltynum == "L2247" 
           & !is.na(last4ccnum) & !is.na(loyaltynum))) %>%
  filter(!(last4ccnum == "5921" & loyaltynum == "L9406" 
           & !is.na(last4ccnum) & !is.na(loyaltynum))) %>%
  filter(!(last4ccnum == "4948" & loyaltynum == "L3295" 
           & !is.na(last4ccnum) & !is.na(loyaltynum)))   

tmp <- mapping %>% dplyr::select(-VehID,-Department)
fjoin <- fjoin %>% 
          arrange(last4ccnum, loyaltynum) %>%
          left_join(tmp, by= c("loyaltynum"="tmpL")) %>%
          mutate(ccard = ifelse(is.na(last4ccnum),tmpC, last4ccnum)) %>%
          mutate(cardtype = ifelse(is.na(loyaltynum),
                                   "credit",
                                   ifelse(is.na(last4ccnum),
                                          "loyalty",
                                          "both"))) %>%
          dplyr::select(-tmpC) 

tmp <- mapping %>% dplyr::select(-tmpL)
fjoin <- fjoin %>% 
          arrange(ccard, timestamp) %>%
          left_join(tmp, by= c("ccard"="tmpC"))

fjoin$wkday <- lubridate::wday(fjoin$date, label= TRUE, abbr = FALSE)
fjoin$hr <- as.integer(fjoin$hr)
fjoin$day <- as.integer(fjoin$day)

write.csv(fjoin, "data/aspatial/credit_loy.csv", row.names  = FALSE)
rm(mapping,tmp)
glimpse(fjoin)
```

## 5.2  Geospatial Tracking and Merged Transaction Data Set

The geospatial tracking data set has 35 and 5 unique private company car and truck respectively. Since there are 54 GASTech personnel, not everyone could be associated with geospatial tracking data. The only link point between the tracking and transactions data sets would be the GPS values for the transaction locations. The values were determined based on an exploration on discerned patterns that would help to grill down into the GPS values in the tracking data. One should progressively hunt for patterns at a smaller subsets such as locations or credit card with low transaction volume, vehicle ID with smaller number of trips, activities on weekends and then expand to larger data subset. Numerous visualisation aids would be used to assist in triangulate the location GPS values. The visaulisation aids as follows: 

1. __Plot via ggplot, ggirafe or ploty__. Example of a location with low transaction volume plot by ggplot with ggirafe. From here,one observed 2540 and 9683 visited the hotel twice a week during the weekdays and timestamp. i.e. Tue/Fri or Wed/Fri. 

```{r}
p <- fjoin %>% separate(timestamp, 
                        into = c("date","time"), 
                        sep=" ",
                        remove = FALSE) %>%
  filter (location=="Chostus Hotel") %>% 
  ggplot(aes(x=day, fill=cardtype)) + 
  geom_bar_interactive(aes(tooltip = time), width=1) +
  scale_fill_manual(values=c("#1569C7", "orange","#2E8B57"))+
  scale_y_continuous(breaks=seq(0,2,1)) +
  scale_x_continuous(breaks=seq(6,19,1)) + 
  labs(title = expression(underline(
    "Transaction at Chostus Hotel with Facet(Credit Card No) & Tooltip.")),
       y="No. of Transaction",
       x=" X Jan 2014",
       fill="Card Type") + 
  facet_grid(row = vars(ccard), scales="free_y", space="free_y")+  
  theme_classic()+ 
  theme(axis.text.x = element_text(size=6),
        axis.text.y = element_text(size=6),
        axis.title.x = element_text(size=8),
        axis.title.y = element_text(size=8),
        panel.grid.minor = element_blank(),
        legend.direction="vertical",
        legend.title = element_text(color = "blue", size = 8),
        legend.background = element_rect(fill = "light yellow"),
        legend.text=element_text(size=7),
        legend.key = element_rect(size = 0.5),
        legend.key.size = unit(0.8, 'lines'),
        plot.title = element_text(size=10,hjust = 0.5,face="bold")
        )
gg <- girafe(ggobj=p, width_svg = 6, height_svg=6*0.618)
gg <- girafe_options(gg, opts_tooltip(opacity = .9,
                                    offx = 20, offy = -10,
                                    use_fill = TRUE,
                                    use_stroke = TRUE,
                                    delay_mouseout = 1000) )
gg
```

2. __datatable__. Leveraging the datatable to zoom into potential vehicle ID where the timestamp was within 15mins of the transaction time. To streamline the data volume so that it was supportable by datetable, only the start point for respective trip would be used. The code chuck to determine the trip start point and datatable was appended below. 

```{r}
cgps$trip <- as.integer(cgps$trip) # format to ease sorting
cgps$id <- as.integer(cgps$id) 

# to find trip start point by group_by id and trip
tmp <- cgps %>% group_by(id,trip) %>% 
  summarise (count =n(),
             timestamp = first(Timestamp),
             lat = first(rlat),
             long= first(rlong)) %>%
  filter(count>1) %>% dplyr::select(-count) %>%
  arrange(id, trip)
```

```{r layout="l-body-outset"}
DT::datatable(tmp, filter ='top',class = 'cell-border stripe',
          rownames=FALSE,
           options = list(autoWidth = TRUE, 
                          columnDefs = list(list(className = 'dt-center',
                                                 targets = "_all"))),
           colnames=c("Vehicle ID","Trip ID", "Timestamp","Lat", "Long ")) %>%
  DT::formatStyle(0, target ='row',color = 'Black',
              backgroundColor = 'light green',
              lineHeight ='70%')
```

3. __tmap__. With the information obtained above, explore the likely vehicle id tracking data via visual matching via tmap plotting and filtering for vehicle id and trip information in tmap. (same source code as in Section 3) 

Plot of Vehicle ID 33 with Trip 16:

```{r}
gps_lines_s <- gps_lines %>%
  filter( id==33, trip==16)

tmap_mode("plot")
tm_shape(bgmap) +
  tm_rgb(bgmap, r = 1,g = 2,b = 3,
       alpha = NA,
       saturation = 1,
       interpolate = TRUE,
       max.value = 255) +
  tm_shape(gps_lines_s) +
  tm_lines(col = "navy", lwd=2, alpah=0.7) +
  tm_layout(main.title = "Vehicle ID 33 Trip 16 Geospatial Tracking Data.",
            main.title.position = "center",
            main.title.size = 1)

```

Progressively exploring from small to larger data subset while compiling the GPS values for the interested locations and tagged it to the geographical tracking data. For company truck, one could focus transaction at industries locations such as Abila Airport, Kronos Pipe and irrigation, Carlyle Chemical Inc, Maximum iron and Steel etc and built up from there.  With the naming tagged, the geospatial tracking data set would be streamlined to only start and end points of all the respective trips for each vehicle id. See code chuck below to tag location naming to geographical tracking data base on a manually complied naming - GPS values csv file.

```{r, trip start and end points}
tmps <- cgps %>% #start point of trip 
        group_by(id,trip) %>%
        summarise (count=n(), timestamp = first(Timestamp),
                   lat = first(rlat), long= first(rlong)) %>%
        filter(count>1) %>% #removing trip with single point
        ungroup()

tmpe <- cgps %>% #end point of trip 
        group_by(id,trip) %>%
        summarise (count=n(),timestamp = last(Timestamp),
                   lat = last(rlat), long= last(rlong)) %>%
        filter(count>1) %>% #removing trip with single point
        ungroup()
        
mgps =  merge(tmps, tmpe, all.x=T, all.y=T)

loc_gps = read_csv("data/aspatial/location_gpsmapping.csv") #
mgps$id <- as.integer(mgps$id)
mgps$trip <- as.integer(mgps$trip)
mgps <- mgps %>% arrange(id, trip, timestamp) %>%
  left_join(loc_gps, by=c("lat", "long"))

write.csv(mgps, "data/aspatial/trip_gps4.csv", row.names  = FALSE)
rm(tmpe,tmps)
```

Manually, one could start to triangulate the matching of credit card with vehicle id by using following visualisation aid: 

1. __Plot via tidygraph, ggirafe or ploty__. Focus on the transaction location and timestamp of respective card holders.

```{r}
g <- fjoin %>%
  filter(ccard  %in% c("6899")) %>%
  arrange(ccard, timestamp) %>%
  separate(timestamp, into = c("dat","time"), sep=" ",remove = FALSE) %>%
  ggplot(aes(x = reorder(location, hr), fill=cardtype)) + 
  geom_bar_interactive(aes(tooltip = time), width=0.5) + 
  facet_grid(ccard~day, scale = 'free') +
  scale_fill_manual(values=c("#1569C7", "orange", "green"))+
  scale_y_continuous(breaks=seq(0,2,1)) +
  labs(title = "Transaction Timestamp at Locations for Credit Card No.",
       y="No. of Transaction",
       x="",
       fill="Card Type") + 
  theme_classic()+ 
  theme(axis.text.x = element_text(size=6,angle=90, vjust= 0.9),
        axis.text.y = element_text(size=6),
        axis.title.y = element_text(size=6),
        panel.grid.minor = element_blank(),
        legend.direction="vertical",
        legend.title = element_text(color = "blue", size = 8),
        legend.background = element_rect(fill = "light yellow"),
        legend.text=element_text(size=7),
        legend.key = element_rect(size = 0.5),
        legend.key.size = unit(0.8, 'lines'),
        plot.title = element_text(size=10,hjust = 0.5,face="bold")
        )
gg <- girafe(ggobj=g, width_svg = 8, height_svg=8*0.618)
gg <- girafe_options(gg, opts_tooltip(opacity = .9,
                                    offx = 20, offy = -10,
                                    use_fill = TRUE,
                                    use_stroke = TRUE,
                                    delay_mouseout = 1000) )
gg
```

2. __timevis__ For timevis, one could merge both transaction and geospatial tracking data sets into one as follow.     

```{r}
# merging GPS with transaction datasets
tmp1 <- fjoin %>% 
  dplyr::select(ccard,timestamp, location) %>% arrange(timestamp) %>%
  rename(id=ccard) 

tmp2 <- mgps %>%
  dplyr::select(id,timestamp, location) %>% 
  arrange(timestamp)

full_ds <- merge(tmp1, tmp2, all.x=T, all.y=T)

glimpse(full_ds)
```

Then prepared the column heading into appropriate data format for timevis. Ensure no duplicate.

```{r}
# filter and grouping code chuck for timevis
visfull_ds <- full_ds %>% filter(id %in% c("6899","5")) %>% 
  mutate(group = id) %>%
  rename(content=location, start=timestamp, cid = id ) %>%
  filter(!is.na(start))

vis_gp <- visfull_ds%>% dplyr::select(group,cid) %>%
  rename(id = group, content = cid) %>%
  group_by(id,content) %>%
  summarise(count=n())

```

Timevis would allow one to view and compared activities in time series. example the plot below allow one to determine activities for credit card 1286 was a good fit to geospatial tracking data of vehicle id 22. One could determine whether transacted location tally with the gps location  based on transacted timeline. However, the data set excluded loyalty card only transaction due to lack of time dimension. Nonetheless, one could use the tracking data to verify indeed whether the card holder present in the location for loyalty card only transaction. Nevertheless, one need to switch between tmap, tidygraph, datatable and timevis to find the most appropriate visualisation for the matching of owner for vehicle id and credit card.

```{r}
timevis::timevis(data = visfull_ds, groups=vis_gp,
                 height="400px", width = "700px")
```

Code chuck and datatable for geospatial tracking tagged with location naming.

```{r,layout="l-body-outset"}
DT::datatable( mgps %>% 
                 dplyr::select(-count, -loctype, -lat, -long) %>%
                 arrange(id,trip),
               rownames = FALSE,
               filter ='top',
               options = list(
                 columnDefs = list(list(className = 'dt-center',
                                    targets = "_all"))),
               colnames = c("Vehicle ID","Trip ID","Timestamp",
                            "Location")) %>%
  DT::formatStyle(0, target ='row',color = 'Black',
                  backgroundColor = 'light green', lineHeight ='70%')
```

## 5.3  Additional Locations

During the EDA, its discern there were location within the geospatial tracking data not associated with the transaction locations such as office GASTech, residential for respective vehicle id etc. To determine the location for respective vehicle id, one could find the start and end points for each day from the geospatial tracking data and then determined the most likely residential location. Thereafter map the residential naming to the dataset again. For those remaining unidentified, would use tmap for visual aid and assigned an arbitrary naming to the location. See code chuck for determine home location. To support EDA further, the locations was tagged with appropriate 4 types in a new column "loctype". i.e. Office = GASTech, Transacted locations, Unknown = non transaction location, Residential = Home based on vehicle ID, Industry = airports, scrapyard etc.       

```{r , finding start and end point for each ID}
# cgps = clean gps data 
# find the start point for each day for respective vehicle ID
tmps <- mgps %>%   
  mutate(date = clock::get_day(timestamp)) %>%
  arrange(id, timestamp) %>% group_by(id,date) %>%
  summarise(timestamp = first(timestamp), long=first(long), lat =first(lat),
            loctype = first(loctype), location = first(location))

# find the end  point for each day for respective vehicle ID
tmpe <- mgps %>%  
  mutate(date = clock::get_day(timestamp)) %>%
  arrange(id, timestamp) %>% group_by(id,date) %>%
  summarise(timestamp = last(timestamp), long=last(long), lat =last(lat),
            loctype = first(loctype), location = first(location))

startend = merge(tmps, tmpe, all.x=T, all.y=T)

write.csv(startend, "data/aspatial/startend.csv", row.names  = FALSE)
rm(tmpe, tmps, loc_gps)
```

## 5.4 Exploring Relationship

To explore relationship among the employee, tidygraph, ggraph, igraph and visNetwork would be used. Nonetheless, numerous data preparation needed to support the visualisation. Sample of a visNetwork was appended below. The transaction data was filter off those whom were truck driver and create a new column period to determining morning, afternoon and night activities. The whole date set was prepared in accordance to the format required by visNetwork for consumption. However, visNetwork might be too messy to manage and thus the exploration here might resolve to visIgraph. 

```{r, prepare the nodes graph} 
pers_nodes <- read_csv("data/aspatial/employee_nodes.csv")
pers_nodes <- pers_nodes%>%rename(group = department)
ccard_edges <- fjoin %>%
  filter (!(ccard %in% c("9614","8642","7792",
                         "2276","9152","4530",
                         "9735","9220","3506"))) %>%
  mutate(period = ifelse(hr<=11,"AM", 
                         ifelse(hr>=18, "NT","PM" ))) %>%
  group_by(ccard,location,period,Department)%>% 
  summarise(weight=n()) %>%
  ungroup()
tmp <- pers_nodes%>%dplyr::select(id,label)
gccard_edges <- ccard_edges %>%
  left_join(tmp,by=c("location"="label" )) %>%
  rename(to = id) %>%
  left_join(tmp,by=c("ccard"="label" )) %>%
  rename(from = id) %>%
  filter(!is.na(from))%>%
  filter(!is.na(to)) %>%
  #filter(Department=="Engineering") %>%
  relocate(from, to,weight, .before=ccard)
gccard_edges$from <- as.numeric(gccard_edges$from)
gccard_edges$to <- as.numeric(gccard_edges$to)
```

```{r}
visNetwork(pers_nodes,gccard_edges) %>%
  #visIgraphLayout(layout = "layout_nicely", physics = ) %>%
  visEdges(smooth = FALSE) %>%
  visGroups(groupname = "Security", color="darkred",
            shape = "square", 
            shadow = list(enabled = TRUE)) %>% 
  visGroups(groupname = "Information Technology", color="darkyellow", 
            shape = "circle",
            shadow = list(enabled = TRUE)) %>%
  visGroups(groupname = "Engineering", color="light blue",
            shape ="triangle") %>% 
  visGroups(groupname = "Executive", color= "orange",
            shape ="star",
            shadow = list(enabled = TRUE)) %>%
  visOptions(selectedBy = "group",
             highlightNearest = TRUE, 
             nodesIdSelection = TRUE,) %>%
  visLayout(randomSeed = 123)%>%
  visInteraction(hideEdgesOnDrag = TRUE) %>%
  visPhysics(solver = "forceAtlas2Based", 
          forceAtlas2Based = list(gravitationalConstant = -200))

```

# 6.0 Exploration Sharing 

## 6.1 Most Popular Location
### 6.1.1 Popular Location
Reference to the chart below, the most popular location was Katerina's Cafe at a count of 254 transactions vs Hippokampos at 211. The main anomaly centered around imperfect transaction information. The merged data set comprised 1081 transactions with both cards details and 720 with either card details only (i.e. 409 with credit and 311 with loyalty card). The 720 was determined as unique transaction since could not be joined based on date, price and location. Due to lack of date time information on loyalty card transactions, it was difficult to determine whether it was different transactions in the same day or same transaction with different values recorded by the loyalty card. Since it was an investigation, respective card transaction should be taken as an independent and valid transaction until proven otherwise. Thus, there might be duplicated transaction count. Nonetheless, a quick assessment on assuming duplication count, Katerina's Cafe would remain to be the most popular location with potential duplicated 28 count. The table below provided information on individual card transactions only where one could verify with the chart.The dataset used has the relationship between credit - loyalty cards mapped out in which it would explain in the later section. 

```{r}
data <- fjoin %>% count(location, cardtype)
fig <- plot_ly(data, x = ~reorder(location,-n,sum), y = ~n,
               type = 'bar', name = ~cardtype)
fig <- fig %>% layout( title = 
                         'Frequency of Transactions @ Places of Interest',
          xaxis = list(title = "Location",
                       tickfont = list(
                         size = 10,
                         color = 'rgb(107, 107, 107)')),
          yaxis = list(title = 'No. of Transactions',
           titlefont = list(
             size = 12,
             color = 'rgb(107, 107, 107)'),
           tickfont = list(
             size = 10,
             color = 'rgb(107, 107, 107)')),
          legend = list(title = list(text='Card Type'),
                        x = 0.85,
                        y = 0.75,
                        bgcolor = '#F7E7CE',
                        bordercolor = '#C0C0C0'),
          barmode = 'stack')
fig
```

```{r ,echo= FALSE,layout="l-body-outset" }
DT::datatable( fjoin %>% 
  dplyr::select(date, location, price,last4ccnum, loyaltynum, cardtype),
  #filter(cardtype !="both") %>%
  filter ='top',class = 'cell-border stripe',rownames=FALSE,
  options = list(
            columnDefs = list(list(className = 'dt-center',
                                   targets = "_all"))
            ),
  colnames = c("Date", "Location", "Price($)","Credit Card No.", 
               "Loyalty Card No.", "Transacted Card")) %>%
  DT::formatStyle(0, target ='row',color = 'Black',
                  backgroundColor = 'light green',
                  lineHeight ='70%')
```

EDA was done on the data set from the above mentioned table. One interesting observation was that Korons Mart and Daily Deals (i.e. 18 and 1 transactions) were places where transactions were performed with either one card only (See Chart Below) as compared to others. In Korons Mart, there seemed to be a pattern where a card holder after a transaction with only loyalty card would have a next day transaction with credit card only . This was different from most scenarios like in Frydos Autosupply, where the main discerned pattern was that individual cards transacted on similar day or it just sporadic transactions.

```{r echo=FALSE}
g <- fjoin %>%
  filter (location=="Kronos Mart") %>% 
  ggplot(aes(x=day, fill=cardtype)) + 
  geom_bar_interactive(aes(tooltip = timestamp, data_id = ccard)) +
  scale_fill_manual(values=c("orange", "#2E8B57"))+
  scale_y_continuous(breaks=seq(0,2,1)) +
  scale_x_continuous(breaks=seq(6,19,1)) + 
  labs(title = expression(underline(
    "Date of Transaction & Count at Kronos Mart with Facet(Credit Card No)")),
       y="No. of Transaction",
       x=" X Jan 2014",
       fill="Card Type") + 
  facet_grid(row = vars(ccard), scales="free_y", space="free_y")+  
  theme_classic()+ 
  theme(axis.text.x = element_text(size=6),
        axis.text.y = element_text(size=6),
        axis.title.x = element_text(size=8),
        axis.title.y = element_text(size=8),
        panel.grid.minor = element_blank(),
        legend.direction="vertical",
        legend.title = element_text(color = "blue", size = 8),
        legend.background = element_rect(fill = "light yellow"),
        legend.text=element_text(size=7),
        legend.key = element_rect(size = 0.5),
        legend.key.size = unit(0.8, 'lines'),
        plot.title = element_text(size=10,hjust = 0.5,face="bold"),
        strip.text.y = element_text(size = 6)
        )

gg <- girafe(ggobj=g, width_svg = 8, height_svg=8*0.618)
gg <- girafe_options(gg, opts_tooltip(opacity = .9,
                                 offx = 20, offy = -10,
                                 use_fill = TRUE, 
                                 use_stroke = TRUE,
                                 delay_mouseout = 1000))
gg
```

```{r echo = FALSE}
g <- fjoin %>%
  separate(timestamp, into = c("dat","time"), sep=" ",remove = FALSE) %>%
  filter(location=="Frydos Autosupply") %>%
  filter(is.na(last4ccnum)|is.na(loyaltynum)) %>%
  ggplot(aes(x=day, fill=cardtype)) + 
  geom_bar_interactive(aes(tooltip = time, data_id = ccard),width=0.9) +
  scale_fill_manual(values=c("orange","#2E8B57")) +
  scale_y_continuous(breaks=seq(0,3,1)) +
  scale_x_continuous(breaks=seq(6,19,1)) + 
  labs(title = expression(underline(
    "Date of Transaction & Count at Frydos Autosupply with Facet(Credit Card No)")),
       y="No. of Transaction",
       x="X Jan 2014",
       fill="Card Type") + 
  facet_grid(row = vars(ccard))+  
  theme_classic()+ 
  theme(axis.text.x = element_text(size=6),
        axis.text.y = element_text(size=6),
        axis.title.x = element_text(size=8),
        axis.title.y = element_text(size=8),
        panel.grid.minor = element_blank(),
        legend.direction="vertical",
        legend.title = element_text(color = "blue", size = 8),
        legend.background = element_rect(fill = "light yellow"),
        legend.text=element_text(size=7),
        legend.key = element_rect(size = 0.5),
        legend.key.size = unit(0.8, 'lines'),
        plot.title = element_text(size=10,hjust = 0.5,face="bold"),
        strip.text.y = element_text(size = 6)
        )

gg <- girafe(ggobj=g, width_svg = 8, height_svg=8*0.618)
gg <- girafe_options(gg, opts_tooltip(opacity = .9,
                                 offx = 20, offy = -10,
                                 use_fill = TRUE, 
                                 use_stroke = TRUE,
                                 delay_mouseout = 1000))
gg
```

### 6.1.2 Popular Time Frame 

We assumed that the credit timestamp information was associated with time of transaction and the card holder left the location within minutes after the transaction. Thus for Katerina's Cafe, the popular time should around -1hr from the time stamp. i.e. busy during lunch (1200 - 1400hrs) and dinner (1700-2000hrs) hours. Based on the date time chart below, its also observed Katerina's cafe do not operate for breakfast timing. For weekend, less customers for lunch hours in particular on Sunday but more tend to stream in earlier for dinner. On weekday, dinner crowd tend to stay longer as compared to weekend. Nonetheless, most customer left prior to 22OOhrs. (The time value for Loyalty card only transaction would be taken as null since its do not have the time stamp)   

```{r} 
p <- fjoin %>% 
  filter (location=="Katerina Cafe")  %>% 
  ggplot(aes(x=day, fill=cardtype)) + 
  geom_bar_interactive(aes(tooltip = ccard, data_id = ccard), width=0.9) + 
  scale_y_continuous(breaks=seq(0,15,5)) +
  scale_x_continuous(breaks=seq(6,19,1)) + 
  labs(title = expression(underline(
    "Transaction Count at Katerina's Cafe with Facet(Hours) from 6-19 Jan 14")),
       y="No. of Transaction",
       x="X Jan 2014",
       fill="Card Type") + 
  scale_fill_manual(values=c("#1569C7", "orange","#2E8B57")) +
  theme_light() +
  facet_grid(row = vars(hr),space="free_y") +
  theme(axis.text.x = element_text(size=4),
        axis.text.y = element_text(size=4),
        axis.title.x = element_text(size=6),
        axis.title.y = element_text(size=6),
        panel.grid.minor = element_blank(),
        legend.direction="vertical",
        legend.title = element_text(color = "blue", size = 6),
        legend.background = element_rect(fill = "light yellow"),
        legend.text=element_text(size=6),
        legend.key = element_rect(size = 0.5),
        legend.key.size = unit(0.8, 'lines'),
        plot.title = element_text(size=8,hjust = 0.5,face="bold"))

girafe(ggobj=p, width_svg = 6, height_svg=6*0.618)
```

When EDA further on the time dimension in day /work day, one could observe that selected locations only have either weekday or weekend transactions. Weekend only transactions were normally associated with recreational like museum, golf course etc. Generally, pace was much slower in the week end as compared to week day especially in the morning.

```{r, location vs day} 
p <- fjoin %>%
  count(day, location) %>%
  arrange(desc(n)) %>%
  ggplot(aes(x=day, y=reorder(location,n, sum), fill = n)) +
  geom_tile_interactive(aes(tooltip = n, data_id = location ),
                        colour="white") +
  scale_x_continuous(breaks=seq(6,19,1)) + 
  labs(title = expression(underline(
    "Date of Transaction at Location of Interest. (6-19 Jan 14)")),
       y="Location",
       x="Day(X Jan 2014)",
       fill ="Transaction Count") + 
  #geom_text(aes(label = n), colour = "orange", size = 2) +
  scale_fill_gradient(low="blue", high="red")+
  theme_classic() +
  theme(axis.text.x = element_text(size=5),
        axis.text.y = element_text(size=5),
        axis.title.x = element_text(size=6),
        axis.title.y = element_text(size=6),
        panel.grid.minor = element_blank(),
        legend.direction="vertical",
        legend.title = element_text(color = "blue", size = 4),
        legend.background = element_rect(fill = "light yellow"),
        legend.text=element_text(size=4),
        legend.key = element_rect(size = 0.5),
        legend.key.size = unit(0.8, 'lines'),
        plot.title = element_text(size=8,hjust = 0.5,face="bold"))

girafe(ggobj=p, width_svg = 8, height_svg=8*0.618)
```

For weekday only transaction, its could categorise into 2 groups, namely industrial vs cafe locations. For industrial locations, it seemed that there were a planned routine for GAStech personnel to visit them. In addition, the GAStech personnel visited most of coffee related cafes only during weekday and in particular at the morning session.

```{r, industrial locations, echo=FALSE} 
p <- fjoin %>% 
  count(day, location) %>% arrange(desc(n)) %>%
  filter( location %in% c("Abila Airport", "Abila Scrapyard",
                          "Max Iron & Steel", "Kronos Pipe",
                          "Carlyle Chemical", "Stewart and Sons",
                          "Nationwide Refinery") )%>%
  ggplot(aes(x=day, y=reorder(location,n, sum), fill = n)) +
  geom_tile_interactive(aes(tooltip = n, data_id = location ),
                        colour="white")+
  scale_x_continuous(breaks=seq(6,19,1)) + 
  labs(title = expression(underline(
    "Date of Transaction at Locations associated with GASTech.(6-19 Jan 14)")),
       y="Location",
       x="X Jan 2014",
       fill ="Transaction Count") + 
  #geom_text(aes(label = n), colour = "orange", size = 2) +
  scale_fill_gradient(low="blue", high="red")+
  theme_classic() +
  theme(axis.text.x = element_text(size=5),
        axis.text.y = element_text(size=5),
        axis.title.x = element_text(size=6),
        axis.title.y = element_text(size=6),
        panel.grid.minor = element_blank(),
        legend.direction="vertical",
        legend.title = element_text(color = "blue", size = 4),
        legend.background = element_rect(fill = "light yellow"),
        legend.text=element_text(size=4),
        legend.key = element_rect(size = 0.5),
        legend.key.size = unit(0.8, 'lines'),
        plot.title = element_text(size=8,hjust = 0.5,face="bold"))

girafe(ggobj=p, width_svg = 6, height_svg=6*0.618) 

```

When delved into transaction time, there were interesting patterns being detected. Example, Kronos Mart was the only place with transaction at 3am+. Series of cafe like Bean There Done That, Jack Magical Beans etc have only 12pm sharp transactions which assessed to be abnormal.(Could verify with the data table provided above) Going through the tooltips in the time plot, one could also determine the peak hours based on transaction vol for the specific location if any.  

```{r, location vs hr} 
p <- fjoin %>% count(hr, location) %>% arrange(desc(n)) %>%
  ggplot(aes(x=hr, y=reorder(location, n, sum), fill = n)) +
  geom_tile_interactive(aes(tooltip = n, data_id = location ),
                        colour="white") +
  scale_x_continuous(breaks=seq(0,24,2)) + 
  labs(title = expression(underline(
    "Transaction Patterns at Place of Interest within a Day")),
       y="Location",
       x="Time(Hr)",
       fill ="Transaction Count") + 
  #geom_text(aes(label = n), colour = "orange", size = 2) +
  scale_fill_gradient(low="blue", high="red")+
  theme_classic()+
  theme(axis.text.x = element_text(size=5),
        axis.text.y = element_text(size=5),
        axis.title.x = element_text(size=6),
        axis.title.y = element_text(size=6),
        panel.grid.minor = element_blank(),
        legend.direction="vertical",
        legend.title = element_text(color = "blue", size = 4),
        legend.background = element_rect(fill = "light yellow"),
        legend.text=element_text(size=4),
        legend.key = element_rect(size = 0.5),
        legend.key.size = unit(0.8, 'lines'),
        plot.title = element_text(size=8,hjust = 0.5,face="bold"))

girafe(ggobj=p, width_svg = 8, height_svg=8*0.618)
```

### 6.1.3 Other Indentified Patterns

It also observed that most card holders have favourite locations that they would patronise very frequently for breakfast, lunch or dinner. For example credit card holders "4434" and "9551",  Brew Served and Hallowed Grounds. So any deviation from the patterns could potential connote anomalies. 

```{r,layout="l-body-outset", echo=FALSE}
fjoin %>% filter(ccard  %in% c("4434")) %>%
  ggplot(aes(x = location, fill=cardtype)) +
  geom_bar_interactive(aes(tooltip = hr), width=0.5) + 
  facet_grid(ccard~day, scale = 'free_x') +
  scale_fill_manual(values=c("#1569C7", "orange", "green"))+
  scale_y_continuous(breaks=seq(0,2,1)) +
  labs(title =  expression(underline(
    "Date of Transaction & Count at Locations for Facet(Credit Card).")),
       y="No. of Transaction",
       x="",
       fill="Card Type") + 
  theme_classic()+ 
  theme(axis.text.x = element_text(size=8,angle=90, vjust= 0.9),
        axis.text.y = element_text(size=6),
        axis.title.y = element_text(size=8),
        panel.grid.minor = element_blank(),
        legend.direction="vertical",
        legend.title = element_text(color = "blue", size = 8),
        legend.background = element_rect(fill = "light yellow"),
        legend.text=element_text(size=7),
        legend.key = element_rect(size = 0.5),
        legend.key.size = unit(0.8, 'lines'),
        plot.title = element_text(size=10,hjust = 0.5,face="bold")
        )
fjoin %>% filter(ccard  %in% c("9551")) %>%
  ggplot(aes(x = location, fill=cardtype)) + 
  geom_bar_interactive(aes(tooltip = hr), width=0.5) + 
  facet_grid(ccard~day, scale = 'free_x') +
  scale_fill_manual(values=c("#1569C7", "orange", "green"))+
  scale_y_continuous(breaks=seq(0,2,1)) +
  labs(title =  expression(underline(
    "Date of Transaction & Count at Locations for Facet(Credit Card).")),
       y="No. of Transaction",
       x="",
       fill="Card Type") + 
  theme_classic()+ 
  theme(axis.text.x = element_text(size=6,angle=90, vjust= 0.9),
        axis.text.y = element_text(size=6),
        axis.title.y = element_text(size=8),
        panel.grid.minor = element_blank(),
        legend.direction="vertical",
        legend.title = element_text(color = "blue", size = 8),
        legend.background = element_rect(fill = "light yellow"),
        legend.text=element_text(size=7),
        legend.key = element_rect(size = 0.5),
        legend.key.size = unit(0.8, 'lines'),
        plot.title = element_text(size=10,hjust = 0.5,face="bold")
        )
```

From the plot on the frequency of transaction for credit cards, one could observe that the transaction activities could potential be cluster into 3 groups. First group (start from 3484 to 8411 in the chart below ) with high frequency of transaction activities and gradually reduced as one move down the chart. Second group (start from 3492 to 4530) with medium frequency of transnational activities but steep reduction curve as move down. Last group, namely 5010, 9152 and 9614 has relatively low frequency of transaction activities. This chart might subsequently aid the correlation of transaction data to geospatial tracking information so that one could associate cluster vehicle ID to vehicle ID icate the card holder based on vehicle ID. Lastly, it was to be noted that credit card 9551 has relative lower number of transactions via both cards as compared to the rest. 

```{r}
data <- fjoin %>% count(ccard, cardtype) 
fig <- plot_ly(data,
               x = ~reorder(ccard,-n,sum),
               y = ~n,
               type = 'bar',
               name = ~cardtype)
fig <- fig %>% layout( title = 
                         "Frequency of Transactions based on Credit Card",
          xaxis = list(title = "Credit Card No.",
                       tickfont = list(
                         size = 10)),
          yaxis = list(title = 'No. of Transactions',
           titlefont = list(
             size = 12),
           tickfont = list(
             size = 10)),
          legend = list(title = list(text='Card Type'),
                        x = 0.85,
                        y = 0.75,
                        bgcolor = '#F7E7CE',
                        bordercolor = '#C0C0C0'),
          barmode = 'stack')
fig
```

## 6.2 Inclusion of Vehicle Geospatial Tracking Data

The geospatial would assist to verify whether the card holder/vehicle owner did travel to the transacted location once mapping of credit card to vehicle ID was done with confidence. With that location information, one could possible gain insights on the whether individual card transaction was done by the card holder/vehicle owner. Nonetheless, GPS has it own inadequacy such as GPS errors. Moreover, the geospatial tracking provide additional insights on possible location that individual has traveled which was beyond the transacted locations.

### 6.2.1 Resolving Individual Card Transaction

1. __Kornos Mart 12hrs late in Credit Card Timestamp__. Reusing the timevis and ggiraph plot in Section 5 for credit card 6816 and vehicle 1d 20 (i.e same owner), the card holder do present in Kronos Mart and left around 20:07 12 Jan which was aligned to the data stamp for loyalty card transaction. However, timestamp on credit card was on 08:01 13 Jan, 12hrs late. This was verified with others credit card holders whom have transactions at Kronos Mart. This explained why the date stamp for credit card transaction one day after a loyalty card date stamp.  

```{r echo =FALSE}
g <- fjoin %>%
  filter(ccard  %in% c("6816")) %>%
  arrange(ccard, timestamp) %>%
  separate(timestamp, into = c("dat","time"), sep=" ",
           remove = FALSE) %>%
  ggplot(aes(x = reorder(location, hr),
             fill=cardtype)) + 
  geom_bar_interactive(aes(tooltip = time),
                       width=0.5) + 
  facet_grid(ccard~day, scale = 'free') +
  scale_fill_manual(values=c("#1569C7", "orange", "green"))+
  scale_y_continuous(breaks=seq(0,2,1)) +
  labs(title =  expression(underline(
    "Transaction Timestamp at Locations for Credit Card No.")),
       y="No. of Transaction",
       x="",
       fill="Card Type") + 
  theme_classic()+ 
  theme(axis.text.x = element_text(size=7,angle=90, vjust= 0.9),
        axis.text.y = element_text(size=6),
        axis.title.y = element_text(size=6),
        panel.grid.minor = element_blank(),
        legend.direction="vertical",
        legend.title = element_text(color = "blue", size = 8),
        legend.background = element_rect(fill = "light yellow"),
        legend.text=element_text(size=7),
        legend.key = element_rect(size = 0.5),
        legend.key.size = unit(0.8, 'lines'),
        plot.title = element_text(size=10,hjust = 0.5,face="bold")
        )
gg <- girafe(ggobj=g, width_svg = 8, height_svg=8*0.618)
gg <- girafe_options(gg, opts_tooltip(opacity = .9,
                                    offx = 20, offy = -10, 
                                    use_fill = TRUE,
                                    use_stroke = TRUE,
                                    delay_mouseout = 1000) )
gg
```

```{r echo=FALSE}
# filter and grouping code chuck for timevis
visfull_ds <- full_ds %>% filter(id %in% c("6816","20")) %>% 
  mutate(group = id) %>%
  rename(content=location, start=timestamp, cid = id ) %>%
  filter(!is.na(start))

vis_gp <- visfull_ds%>% dplyr::select(group,cid) %>%
 rename(id = group, content = cid) %>%
  group_by(id,content) %>%
  summarise(count=n())

timevis::timevis(data = visfull_ds, groups=vis_gp,
                 height="400px", width = "700px")
```

2. __The Myth of 12pm Cafe__. From the chart below for vehicle id 5 and credit card 6899 (i.e.same owner), one could observe that vehicle left Jack Magical Beam in the morning whenever there was a captured transaction and not 12pm timestamp under the transaction records. Need to investigate those locations to determine whether the difference in credit card timestamp was due to system error or someone foul play. The timestamp for the vehicle id plot connotted the time the vehicle left the place of location.

```{r echo =FALSE}
g <- fjoin %>% filter(ccard  %in% c("6899")) %>%#6899
  arrange(ccard, timestamp) %>%
  separate(timestamp, into = c("dat","time"), sep=" ",
           remove = FALSE) %>%
  ggplot(aes(x = reorder(location, hr),
             fill=cardtype)) + 
  geom_bar_interactive(aes(tooltip = time),
                       width=0.5) + 
  facet_grid(ccard~day, scale = 'free') +
  scale_fill_manual(values=c("#1569C7", "orange", "green"))+
  scale_y_continuous(breaks=seq(0,2,1)) +
  labs(title =  expression(underline(
    "Transaction Timestamp at Locations for Credit Card No.")),
       y="No. of Transaction",
       x="",
       fill="Card Type") + 
  theme_classic()+ 
  theme(axis.text.x = element_text(size=7,angle=90, vjust= 0.9),
        axis.text.y = element_text(size=6),
        axis.title.y = element_text(size=6),
        panel.grid.minor = element_blank(),
        legend.direction="vertical",
        legend.title = element_text(color = "blue", size = 8),
        legend.background = element_rect(fill = "light yellow"),
        legend.text=element_text(size=7),
        legend.key = element_rect(size = 0.5),
        legend.key.size = unit(0.8, 'lines'),
        plot.title = element_text(size=10,hjust = 0.5,face="bold")
        )
gg <- girafe(ggobj=g, width_svg = 8, height_svg=8*0.618)
gg <- girafe_options(gg, opts_tooltip(opacity = .9,
                                    offx = 20, offy = -10, 
                                    use_fill = TRUE,
                                    use_stroke = TRUE,
                                    delay_mouseout = 1000) )
gg
```
```{r echo =FALSE}
g <- mgps %>%
  filter(id  %in% c("5")) %>%
  group_by(id,trip) %>% 
  summarise (count =n(),
             timestamp = first(timestamp),
             location = first(location),
             loctype=first(loctype)) %>%
  filter( !(location %in% c("GASTech", "5"))) %>%
  separate(timestamp, into = c("date","time"), sep=" ",remove = TRUE) %>%
  separate(date, into = c("yr","mth","day"), sep="-",remove = TRUE) %>%
  ggplot(aes(x = location, fill=loctype)) + 
  geom_bar_interactive(aes(tooltip = time), width=0.5) + 
  facet_grid(id~day, scale = 'free') +
  #scale_fill_manual(values=c("#1569C7", "orange", "green"))+
  scale_y_continuous(breaks=seq(0,2,1)) +
  labs(title =  expression(underline("Traveled Locations for Vehicle ID.")),
       y="No. of Transaction",
       x="",
       fill="Location Type") + 
  theme_classic()+ 
  theme(axis.text.x = element_text(size=7,angle=90, vjust= 0.9),
        axis.text.y = element_text(size=6),
        axis.title.y = element_text(size=6),
        panel.grid.minor = element_blank(),
        legend.direction="vertical",
        legend.title = element_text(color = "blue", size = 8),
        legend.background = element_rect(fill = "light yellow"),
        legend.text=element_text(size=7),
        legend.key = element_rect(size = 0.5),
        legend.key.size = unit(0.8, 'lines'),
        plot.title = element_text(size=10,hjust = 0.5,face="bold"),
        strip.text.x = element_text(size = 6)
        )
gg <- girafe(ggobj=g, width_svg = 8, height_svg=8*0.618)
gg <- girafe_options(gg, opts_tooltip(opacity = .9,
                                    offx = 20, offy = -10,
                                    use_fill = TRUE,
                                    use_stroke = TRUE,
                                    delay_mouseout = 1000) )
gg
```

3. __Validity of Individual Card Transactions__. Actually most individual cards transaction regardless whether on the similar days, were valid transactions as verified with geospatial tracking data of the card holders. For card transaction on the same day but different expense being charged. this should verify with the stores as there could some promotion charge rate for loyalty card. eg reference to the plots above for vehicle ID 5 and 20. However, some individual card transactions especially on loyalty card could not be validated. eg Loyalty card only transaction at Brewed Served on 9 Jan for vehicle ID 20 could be verified as valid. Similiar type of locations especially for Katerina's Cafe could not be verified with geospatial tracking data. However, it also to be noted that for the case of vehicle ID 5 as in Section 5.1, vehicle ID owner (i.e. Credit Card 6899) was assigned as the primary loyalty card holder when detected it was co-shared with credit card 6691.  This assignment could result in a higher non verified loyalty card only transactions in this case.

4. __Present or Not Present__. With geospatial data, new insights or uncertainty were also introduced. eg Vehicle 20 present on Hippokampos on 15 Jan for `~75mins during lunch time without transaction. It was observed that even with both card transactions like in credit card 7253 and vehicle ID 6 (same owner) i.e. both cards transactions record on 17 Jan at Kalami Kafenion cannot be verified with geospatial tracking data. That the complexity in this investigation. Technically, many possible scenarios. There could be carpooling  where either card holder/vehicle owner drove to the place and someone paid for the meal or vice verse. When explore deeper, this could be verified by credit card 7889, vehicle ID 8 where it has a geospatial tracking data records to Kalami Kafenio on 17 Jan around the same timing but without expenses record. In summary, there were transactional records at location without geospatial tracking data and vice verse.

```{r echo =FALSE}
g <- fjoin %>%
  filter(ccard  %in% c("7253")) %>%
  arrange(ccard, timestamp) %>%
  separate(timestamp, into = c("dat","time"), sep=" ",
           remove = FALSE) %>%
  ggplot(aes(x = reorder(location, hr),
             fill=cardtype)) + 
  geom_bar_interactive(aes(tooltip = time),
                       width=0.5) + 
  facet_grid(ccard~day, scale = 'free') +
  scale_fill_manual(values=c("#1569C7", "orange", "green"))+
  scale_y_continuous(breaks=seq(0,2,1)) +
  labs(title =  expression(underline(
    "Transaction Timestamp at Locations for Credit Card No.")),
       y="No. of Transaction",
       x="",
       fill="Card Type") + 
  theme_classic()+ 
  theme(axis.text.x = element_text(size=7,angle=90, vjust= 0.9),
        axis.text.y = element_text(size=6),
        axis.title.y = element_text(size=6),
        panel.grid.minor = element_blank(),
        legend.direction="vertical",
        legend.title = element_text(color = "blue", size = 8),
        legend.background = element_rect(fill = "light yellow"),
        legend.text=element_text(size=7),
        legend.key = element_rect(size = 0.5),
        legend.key.size = unit(0.8, 'lines'),
        plot.title = element_text(size=10,hjust = 0.5,face="bold")
        )
gg <- girafe(ggobj=g, width_svg = 8, height_svg=8*0.618)
gg <- girafe_options(gg, opts_tooltip(opacity = .9,
                                    offx = 20, offy = -10, 
                                    use_fill = TRUE,
                                    use_stroke = TRUE,
                                    delay_mouseout = 1000) )
gg
```
```{r echo =FALSE}
g <- mgps %>%
  filter(id  %in% c("6")) %>%
  group_by(id,trip) %>% 
  summarise (count =n(),
             timestamp = first(timestamp),
             location = first(location),
             loctype=first(loctype)) %>%
  filter( !(location %in% c("GASTech", "6/25/29"))) %>%
  separate(timestamp, into = c("date", "time"), sep=" ", remove = TRUE) %>%
  separate(date, into = c("yr","mth","day"), sep="-",remove = TRUE) %>%
  ggplot(aes(x = location, fill=loctype)) + 
  geom_bar_interactive(aes(tooltip = time), width=0.5) + 
  facet_grid(id~day, scale = 'free') +
  #scale_fill_manual(values=c("#1569C7", "orange", "green"))+
  scale_y_continuous(breaks=seq(0,2,1)) +
  labs(title =  expression(underline("Traveled Locations for Vehicle ID.")),
       y="No. of Transaction",
       x="",
       fill="Location Type") + 
  theme_classic()+ 
  theme(axis.text.x = element_text(size=7,angle=90, vjust= 0.9),
        axis.text.y = element_text(size=6),
        axis.title.y = element_text(size=6),
        panel.grid.minor = element_blank(),
        legend.direction="vertical",
        legend.title = element_text(color = "blue", size = 8),
        legend.background = element_rect(fill = "light yellow"),
        legend.text=element_text(size=7),
        legend.key = element_rect(size = 0.5),
        legend.key.size = unit(0.8, 'lines'),
        plot.title = element_text(size=10,hjust = 0.5,face="bold"),
        strip.text.x = element_text(size = 6)
        )
gg <- girafe(ggobj=g, width_svg = 8, height_svg=8*0.618)
gg <- girafe_options(gg, opts_tooltip(opacity = .9,
                                    offx = 20, offy = -10,
                                    use_fill = TRUE,
                                    use_stroke = TRUE,
                                    delay_mouseout = 1000) )
gg
```

5. __Shift System In Place for Transportation to Industrial Locations__. When explored further, there seemed to be a shift system in place for visitation to industrial location like airport, refinery, chemical and scrapyard etc. eg of visitation to airport after verify with geospatial tracking data. eg credit card 2276 duty was on every Tuesday  and Wednesday. 

```{r echo=FALSE}
g <- fjoin %>%
  filter (location=="Abila Airport") %>% 
  ggplot(aes(x=day, fill=Department)) + 
  geom_bar_interactive(aes(tooltip = ccard), width=1) +
  scale_y_continuous(breaks=seq(0,2,1)) +
  scale_x_continuous(breaks=seq(6,19,1)) + 
  labs(title = expression(underline(
    "Date of Transaction & Count at Abila Airport with Facet(Credit Card No)")),
       y="No. of Transaction",
       x=" X Jan 2014",
       fill="Card Type") + 
  facet_grid(row = vars(ccard), scales="free_y", space="free_y")+  
  theme_classic()+ 
  theme(axis.text.x = element_text(size=6),
        axis.text.y = element_text(size=6),
        axis.title.x = element_text(size=8),
        axis.title.y = element_text(size=8),
        panel.grid.minor = element_blank(),
        legend.direction="vertical",
        legend.title = element_text(color = "blue", size = 8),
        legend.background = element_rect(fill = "light yellow"),
        legend.text=element_text(size=7),
        legend.key = element_rect(size = 0.5),
        legend.key.size = unit(0.8, 'lines'),
        plot.title = element_text(size=10,hjust = 0.5,face="bold"),
        strip.text.y = element_text(size = 6)
        )

gg <- girafe(ggobj=g, width_svg = 8, height_svg=8*0.618)
gg <- girafe_options(gg, opts_tooltip(opacity = .9,
                                 offx = 20, offy = -10,
                                 use_fill = TRUE, 
                                 use_stroke = TRUE,
                                 delay_mouseout = 1000))
gg
```


### 6.2.1 Additional Insight from GPS Geospatial Data

Reference to location setting stipulated in section 5.3, a bar chart stipulated on location type was shown below. Code chuck was relatively similar to the above less some changes in the parameters, thus it would not be displayed here. From the chart, "NA" referred to inconsistent location due to GPS error. This largely happened to Vehicle ID 28 (see plot below) and less on 9. Truck 105 and 101 might violate company policy where trucks were not mean for personnel usage if visited to locations beyond the industrial sites were exclusive. Interestingly, vehicle ID 15,24,13 and 21 less of ID 35,25,34,23 travelled beyond those identified transactions locations. From the Vehicle plot charts above, one should also notice that informal/formal visit by owner of Vehicle 6 and 5 to Vehicle ID 2 house on 10 Jan and left in the night. Moreover, due to GPS inaccuracy, some of the home location would be collated as a single point which was unlikely in reality. This was to avoiding duplicating the point when doing join operations.
 
```{r, echo=FALSE }
data <- mgps %>%
  count(id, loctype)%>%
  mutate(loctype=ifelse(is.na(loctype),"NA",loctype))
fig <- plot_ly(data,
               x = ~reorder(id,-n,sum),
               y = ~n, type = 'bar',
               name = ~loctype,
               color = ~loctype,
               colors=c("steel blue","grey 50","orange",
                        "sky blue","yellow green","red")
               )
fig <- fig %>% layout( title =
                         'Numnber of Travelled Locations based on Vehcile ID',
          xaxis = list(title = "Vehicle ID",
                       tickfont = list(
                         size = 10)),
          yaxis = list(title = 'No. of Locations',
           titlefont = list(
             size = 12),
           tickfont = list(
             size = 10)),
          legend = list(title = list(text='Location Type'),
                        x = 0.95,
                        y = 0.75,
                        bgcolor = '#F7E7CE',
                        bordercolor = '#C0C0C0'),
          barmode = 'stack')
fig
```

```{r echo = FALSE}
gps_points_s <- gps_points %>% 
   filter(id==28)

tmap_mode("plot")
tm_shape(bgmap) +
  tm_rgb(bgmap, r =1,g = 2,b =3,
         alpha = NA,
         saturation = 1,
         interpolate = TRUE,
         max.value = 255) +
  tm_shape(gps_points_s) + 
  tm_facets(by="id",free.coords = FALSE) +
  tm_dots("navy", size = .05) +
  tm_layout(panel.label.rot = c(0, 90), panel.label.size = 2) +
    tm_layout(main.title = "Vehicle ID 28 with Error Geospatial Tracking Data.",
            main.title.position = "center",
            main.title.size = 1)
```

```{r echo =FALSE}
g <- mgps %>%
  filter(id  %in% c("24")) %>%
  group_by(id,trip) %>% 
  summarise (count =n(),
             timestamp = first(timestamp),
             location = first(location),
             loctype=first(loctype)) %>%
  filter( !(location %in% c("GASTech", "17/24/33"))) %>%
  separate(timestamp, into = c("date","time"), sep=" ",remove = TRUE) %>%
  separate(date, into = c("yr","mth","day"), sep="-",remove = TRUE) %>%
  ggplot(aes(x = location, fill=loctype)) + 
  geom_bar_interactive(aes(tooltip = time), width=0.5) + 
  facet_grid(id~day, scale = 'free') +
  scale_y_continuous(breaks=seq(0,2,1)) +
  labs(title =  expression(
    underline("Travelled to Unknown Locations for Vehicle ID 24.")),
    y="No. of Transaction",
    x="",
    fill="Card Type") + 
  theme_classic()+ 
  theme(axis.text.x = element_text(size=6,angle=90, vjust= 0.9),
        axis.text.y = element_text(size=6),
        axis.title.y = element_text(size=6),
        panel.grid.minor = element_blank(),
        legend.direction="vertical",
        legend.title = element_text(color = "blue", size = 8),
        legend.background = element_rect(fill = "light yellow"),
        legend.text=element_text(size=7),
        legend.key = element_rect(size = 0.5),
        legend.key.size = unit(0.8, 'lines'),
        plot.title = element_text(size=10,hjust = 0.5,face="bold"),
        strip.text.x = element_text(size = 6)
        )
gg <- girafe(ggobj=g, width_svg = 8, height_svg=8*0.618)
gg <- girafe_options(gg, opts_tooltip(opacity = .9,
                                    offx = 20, offy = -10,
                                    use_fill = TRUE,
                                    use_stroke = TRUE,
                                    delay_mouseout = 1000) )
gg
```

The other insight was missing GPS data, this was different from transacted without vehicle at the locations, this was where a the whole GPS data on particular day was missing from the geospatial dataset. eg same owner for credit card 5921 and 3547 with vehicle ID 29 where one could observed that geospatial data on 11 and 19 Jan were missing. In summary, geospatial tracking data allowed us to verify most of the transactions identified as anomalies with transaction information only. However, new insights and uncertainty were also gleaned. i.e new travelled locations, vehicle at locations without transactions, transacted timestamp without vehicle at the locations, error GPS tracking data, missing GPS data.  

```{r echo =FALSE}
g <- fjoin %>% filter(ccard  %in% c("5921","3547")) %>%
  arrange(ccard, timestamp) %>%
  separate(timestamp, into = c("dat","time"), sep=" ",
           remove = FALSE) %>%
  ggplot(aes(x = reorder(location, hr),
             fill=cardtype)) + 
  geom_bar_interactive(aes(tooltip = time),
                       width=0.5) + 
  facet_grid(ccard~day, scale = 'free') +
  scale_fill_manual(values=c("#1569C7", "orange", "green"))+
  scale_y_continuous(breaks=seq(0,2,1)) +
  labs(title =  expression(underline(
    "Transaction Timestamp at Locations for Credit Card No.")),
       y="No. of Transaction",
       x="",
       fill="Card Type") + 
  theme_classic()+ 
  theme(axis.text.x = element_text(size=7,angle=90, vjust= 0.9),
        axis.text.y = element_text(size=6),
        axis.title.y = element_text(size=6),
        panel.grid.minor = element_blank(),
        legend.direction="vertical",
        legend.title = element_text(color = "blue", size = 8),
        legend.background = element_rect(fill = "light yellow"),
        legend.text=element_text(size=7),
        legend.key = element_rect(size = 0.5),
        legend.key.size = unit(0.8, 'lines'),
        plot.title = element_text(size=10,hjust = 0.5,face="bold")
        )
gg <- girafe(ggobj=g, width_svg = 8, height_svg=8*0.618)
gg <- girafe_options(gg, opts_tooltip(opacity = .9,
                                    offx = 20, offy = -10, 
                                    use_fill = TRUE,
                                    use_stroke = TRUE,
                                    delay_mouseout = 1000) )
gg
```

```{r echo =FALSE}
g <- mgps %>%
  filter(id  %in% c("29")) %>%
  group_by(id,trip) %>% 
  summarise (count =n(),
             timestamp = first(timestamp),
             location = first(location),
             loctype=first(loctype)) %>%
  filter( !(location %in% c("GASTech", "6/25/29"))) %>%
  separate(timestamp, into = c("date","time"), sep=" ",remove = TRUE) %>%
  separate(date, into = c("yr","mth","day"), sep="-",remove = TRUE) %>%
  ggplot(aes(x = location, fill=loctype)) + 
  geom_bar_interactive(aes(tooltip = time), width=0.5) + 
  facet_grid(id~day, scale = 'free') +
  scale_y_continuous(breaks=seq(0,2,1)) +
  labs(title =  expression(underline("Traveled Locations for Vehicle ID.")),
       y="No. of Transaction",
       x="",
       fill="Card Type") + 
  theme_classic()+ 
  theme(axis.text.x = element_text(size=6,angle=90, vjust= 0.9),
        axis.text.y = element_text(size=6),
        axis.title.y = element_text(size=6),
        panel.grid.minor = element_blank(),
        legend.direction="vertical",
        legend.title = element_text(color = "blue", size = 8),
        legend.background = element_rect(fill = "light yellow"),
        legend.text=element_text(size=7),
        legend.key = element_rect(size = 0.5),
        legend.key.size = unit(0.8, 'lines'),
        plot.title = element_text(size=10,hjust = 0.5,face="bold"),
        strip.text.x = element_text(size = 6)
        )
gg <- girafe(ggobj=g, width_svg = 8, height_svg=8*0.618)
gg <- girafe_options(gg, opts_tooltip(opacity = .9,
                                    offx = 20, offy = -10,
                                    use_fill = TRUE,
                                    use_stroke = TRUE,
                                    delay_mouseout = 1000) )
gg
```

## 6.3 Owner Identification. 

As reference to section 5.1, would conclude that the mapping of credit to loyalty card were with certainty. However, due to double usage of loyalty card by selected credit card owners i.e. 6899 and 6691 that resulted in assigned of loyalty card to the higher usage credit card, there might be uncertainty in mapping of loyalty card only transaction to the geospatial tracking data. On mapping of vehicle ID to credit card so to identify the owner, there were generally 4 groups,  (1) with full verification of transaction with geospatial tracking data, high certainty in association. (2a) small amount unverified transaction records (i.e. 1-2) with majority verified, relatively high certainty in association, (2b) large chuck of unverified records (i.e. more than 5 vehicle ID 1,5,9,29) either due to missing geospatial tracking data or missing transaction records, certainty in association after applying elimination strategy to the remaining data set, (3) unable to associate like vehicle Id 28 due to highly in accurate geospatial tracking data, (4) truck drivers group where we could associated the vehicle ID to a group of credit card owners and mapped out their working schedule since the driver co-shared the trucks. 


```{r, echo=TRUE}
GAStech_node<- read_csv("data/aspatial/employeeinfo.csv")
DT::datatable( GAStech_node %>% 
  dplyr::select(-PersID, -FirstName,-LastName),
  filter ='top',class = 'cell-border stripe',rownames=FALSE,
  options = list(
            columnDefs = list(list(className = 'dt-center',
                                   targets = "_all"))
            )) %>%
  DT::formatStyle(0, target ='row',color = 'Black',
                  backgroundColor = 'light green',
                  lineHeight ='70%')
```

The established shift routine for the truck drivers were appended below. 
```{r}
truck<- read_csv("data/aspatial/truck_shift.csv")
DT::datatable( truck ,
  filter ='top',class = 'cell-border stripe',rownames=FALSE,
  options = list(
            columnDefs = list(list(className = 'dt-center',
                                   targets = "_all"))
            ),
  colnames = c("Credit Card", "Loyalty Card", "Vehicle ID","Shift")) %>%
  DT::formatStyle(0, target ='row',color = 'Black',
                  backgroundColor = 'light green',
                  lineHeight ='70%')
```
It would be good to verify whether the sudden purchased by 9614 on Friday 10 Jan was something approved by company to ensure no foul play. The actions by credit card 9614 was deemed as an anomaly when compared across the shift schedule.



## 6.4 Relationship.
## 6.4.1 Relationship Determine from Transactions

Technical there were two means to determine the relationship, via the transaction or geographical tracking. Code chuck to explore the relationship via department (security) for morning preiod  was appended below and using visIgraph.

```{r} 
gcloc <- fjoin %>% filter(!is.na(hr)) %>%
  mutate(period = ifelse(hr<=11,"AM", ifelse(hr>=18, "NT","PM" ))) %>%
  group_by(ccard,location,period,Department) %>%
  summarise(weight=n()) %>%
  ungroup() %>%
  filter(Department=="Security") %>%
  filter(period =="AM")
gcl<- graph.data.frame(gcloc, directed = TRUE)
V(gcl)$type <- bipartite_mapping(gcl)$type # assign vertex or nodes
visIgraph(gcl) %>% visIgraphLayout(layout = "layout_as_bipartite") %>%
  visNodes(size=15) %>%
  visOptions(nodesIdSelection = TRUE,
             highlightNearest = TRUE )

DT::datatable( gcloc %>% arrange(desc(location)) %>%
  dplyr::select(ccard, location, weight),
  filter ='top',class = 'cell-border stripe',rownames=FALSE,
  options = list(
            columnDefs = list(list(className = 'dt-center',
                                   targets = "_all"))
            )) %>%
  DT::formatStyle(0, target ='row',color = 'Black',
                  backgroundColor = 'light green',
                  lineHeight ='70%')
```

From the table and visIgraph, one could determine that most of the department has their own common hot spot for breakfast and lunch. However, there would always be an outlier where an individual do not really patronise the same. eg 7018 preferrence for Hallowed Ground as compared to Brew Served by the rest. It was also interesting to note that 4434 and 6816 have a breakfast meet up on 17 Jun at Coffee Cameleon as it was a deviation from the norm. That the combination of both would be very useful for us to determine some formal or informal relationship.   

```{r, echo=FALSE} 
gcloc <- fjoin %>% filter(!is.na(hr)) %>%
  mutate(period = ifelse(hr<=11,"AM", ifelse(hr>=18, "NT","PM" ))) %>%
  group_by(ccard,location,period,Department) %>%
  summarise(weight=n()) %>%
  ungroup() %>%
  filter(Department=="Information Technology") #%>%
  #filter(period =="AM")
gcl<- graph.data.frame(gcloc, directed = TRUE)
V(gcl)$type <- bipartite_mapping(gcl)$type # assign vertex or nodes
visIgraph(gcl) %>% visIgraphLayout(layout = "layout_as_bipartite") %>%
  visNodes(size=15) %>%
  visOptions(nodesIdSelection = TRUE,
             highlightNearest = TRUE )
DT::datatable( gcloc %>% arrange(desc(location)) %>%
  dplyr::select(ccard, location, weight),
  filter ='top',class = 'cell-border stripe',rownames=FALSE,
  options = list(
            columnDefs = list(list(className = 'dt-center',
                                   targets = "_all"))
            )) %>%
  DT::formatStyle(0, target ='row',color = 'Black',
                  backgroundColor = 'light green',
                  lineHeight ='70%')
```

On the contrary when explore into the morning session for information technology department, one could observed the department do not really have a common breakfast location. However, when explore further, they do have a common place that they would patronize for lunch. When plot the all the transaction activities, one of the beauty from the igraph bipartite plot was that it has somehow cluster the nodes into some form of community base on place of visits. One could discern that 6899 (veh ID 5), 7889 (veh ID 8) and 7384 (veh ID 17) could form a community. Thus the potential meet up of 7253 (GM Facilities) with 7899 (veh ID 8) on 17 in Kalami Kafenion might ring a bell. (i.e. based on observation on timestamp for vehicle ID, transaction records and time stamp) Could not deduce more as the study did not really zoom into whether they were together at the same time in those places. Timevis could be used to validate there when desire. 

```{r, echo=FALSE} 
gcloc <- fjoin %>% filter(!is.na(hr)) %>%
  mutate(period = ifelse(hr<=11,"AM", ifelse(hr>=18, "NT","PM" ))) %>%
  group_by(ccard,location,period,Department) %>%
  summarise(weight=n()) %>%
  ungroup() %>%
  filter(Department=="Executive") #%>%
  #filter(period =="PM")
gcl<- graph.data.frame(gcloc, directed = TRUE)
V(gcl)$type <- bipartite_mapping(gcl)$type # assign vertex or nodes
visIgraph(gcl) %>% visIgraphLayout(layout = "layout_as_bipartite") %>%
  visNodes(size=15) %>%
  visOptions(nodesIdSelection = TRUE,
             highlightNearest = TRUE )

DT::datatable( gcloc %>% arrange(desc(location)) %>%
  dplyr::select(ccard, location, weight),
  filter ='top',class = 'cell-border stripe',rownames=FALSE,
  options = list(
            columnDefs = list(list(className = 'dt-center',
                                   targets = "_all"))
            )) %>%
  DT::formatStyle(0, target ='row',color = 'Black',
                  backgroundColor = 'light green',
                  lineHeight ='70%')
```

When explore into the executive on above, they do not have a common place in the morning but they do for lunch. The graph above was based on all the transaction incurred by the executive over the period. It should be noted that the transaction records for 5010 i.e. CEO only from 17 to 19 Jan as it assessed that he might be overseas prior to that. Moreover he stayed in the hotel. It could be discerned that 8156 (COO) and 7688(CFO) seemed to have more common interest. However, 8156 and 2463 (ESA veh ID 35) regular breakfast place was Jack Magical Beans. 

```{r, echo=FALSE} 
gcloc <- fjoin %>% filter(!is.na(hr)) %>%
  mutate(period = ifelse(hr<=11,"AM", ifelse(hr>=18, "NT","PM" ))) %>%
  group_by(ccard,location,period,Department) %>%
  summarise(weight=n()) %>%
  ungroup() %>%
  filter(Department=="Engineering") #%>%
  #filter(period =="AM")
gcl<- graph.data.frame(gcloc, directed = TRUE)
V(gcl)$type <- bipartite_mapping(gcl)$type # assign vertex or nodes
visIgraph(gcl) %>% visIgraphLayout(layout = "layout_as_bipartite") %>%
  visNodes(size=15) %>%
  visOptions(nodesIdSelection = TRUE,
             highlightNearest = TRUE )
DT::datatable( gcloc %>% arrange(desc(location)) %>%
  dplyr::select(ccard, location, weight),
  filter ='top',class = 'cell-border stripe',rownames=FALSE,
  options = list(
            columnDefs = list(list(className = 'dt-center',
                                   targets = "_all"))
            )) %>%
  DT::formatStyle(0, target ='row',color = 'Black',
                  backgroundColor = 'light green',
                  lineHeight ='70%')
```

A quick look was that 1321 (veh ID 11) deemed to be in his own community based on place of interest. When zoom into breakfast session, 1415 (veh ID 2) and 9683 (veh ID 33, Brewed Served) tend to be alone and not the common breakfast location Hallowed Grounds. 2142 and 3547 shared common breakfast interest at Coffee Cameleon . it also interesting to note that 2540 (veh ID 7, female) and 9683 (male) seemed to visit the hotel twice a week a during lunch time with some regular pattern. Other than them, the next person in the company that visited the hotel was the CEO.

## 6.4.2. Relationship Determine from Geospatial
The potential relationship here was determined based on travelling of a vehicle to other residential. The relationship here was deemed as informal as when dig deeper one could realise the visitation could beyond normal hours. 

```{r, echo=FALSE} 
pr_nodes <- read_csv("data/aspatial/employee_nodes2.csv")
pr <- mgps %>%
  filter (loctype== "Residential") %>%
  filter(id!=location) %>% 
  count(id,location) %>% 
  filter(n<3)%>%
  rename(from=id, to =location, weight=n)

visNetwork(pr_nodes,pr) %>%
  visEdges(arrows = "to") %>% 
  visIgraphLayout(layout = "layout_nicely", physics = ) %>%
  visEdges(smooth = FALSE) %>%
  visGroups(groupname = "Security", color="red",
            shape = "square", 
            shadow = list(enabled = TRUE)) %>% 
  visGroups(groupname = "Information Technology", color="green", 
            shape = "circle",
            shadow = list(enabled = TRUE)) %>%
  visGroups(groupname = "Engineering", color="darkyellow",
            shape ="triangle") %>% 
  visGroups(groupname = "Executive", color= "orange",
            shape ="star",
            shadow = list(enabled = TRUE)) %>%
  visOptions(selectedBy = "group",
             highlightNearest = TRUE, 
             nodesIdSelection = TRUE,) %>%
  visLayout(randomSeed = 123)%>%
  visInteraction(hideEdgesOnDrag = TRUE) %>%
  visPhysics(solver = "forceAtlas2Based", 
          forceAtlas2Based = list(gravitationalConstant = -200))

DT::datatable( mgps %>%
                 filter (loctype== "Residential") %>%
                 filter(id!=location) %>%
                 filter(str_length(location)<6)%>%
                 dplyr::select(id,location,timestamp),
  filter ='top',class = 'cell-border stripe',rownames=FALSE,
  options = list(
            columnDefs = list(list(className = 'dt-center',
                                   targets = "_all"))
            )) %>%
  DT::formatStyle(0, target ='row',color = 'Black',
                  backgroundColor = 'light green',
                  lineHeight ='70%')
```

From the visNetwork, one could observe there was a gathering in veh ID 2 (credit card 1415) house on 10 Jan where attendees were mostly from his own engineering  and information. Thus the intra-relationship between engineering and security could be weak.Then within engineering, vehicle ID 19 (credit card 6895) and 27 (credit card 3492) did not attend. Thus form previous postulation that 1415 tend to have breakfast on his own, it do not connote the bad relationship with his department . It was also interesting to observe that separately the security department visited the select executive after office hours. The visit seemed to be a staggered visit or shift system and might be interesting to discover the rationale. However, it lasted till 14 Jan only. Lastly, vehicle ID 21 (credit card 9405) seemed to have relationship with like veh id 18 (credit card 9617) given the frequent spending over night in her place. (could be 17 as the gps location between 18 and 17 was very close even thought one or two GPS points were different)


## 6.5 Areas for Further Investigation 

Potential Areas of suspicious activitives were as follows: 

1. __Outlier in Expense at Locations__. From the chart below, one could observe extraordinary spending in Frydos Autosupply n More ($10k on 13 Jan by card 9551/veh id 1 from IT department). In addition Albert Clothing (~$1.24K on 17 Jan by card 1321 / veh id 11 from Engineering department). 

```{r}
p <- fjoin%>%
  ggplot(aes(x = reorder(location, -price), y = price)) + 
  geom_boxplot(fill="pink") + 
  facet_grid(cardtype~., scale = 'free') +
  labs(title = "Statistical Analysis on Transaction Amount at Location.",
       y="Price($)",
       x="") + 
  theme_classic()+ 
  theme(axis.text.x = element_text(size=8,angle=90, vjust= 0.9),
        axis.text.y = element_text(size=6),
        axis.title.y = element_text(size=6),
        panel.grid.minor = element_blank(),
        plot.title = element_text(size=10,hjust = 0.5,face="bold")
        )
ggplotly(p)
```

Credit card 9551 also have great desyn in the transaction records vs geospatial tracking in particular for transaction on 13 Jan. 9551 also has the high percentage of transaction with loyatly card only , possible means to cover up time stamp transaction. The missing transaction for U-pump on 13 could be associated with credit card 4344 (in Section 6.1) (vehicle ID 24 security) where it has a geospatial tracking on U pump around same timing but without transacitons.  

```{r echo =FALSE}
g <- fjoin %>%
  filter(ccard  %in% c("9551")) %>%
  arrange(ccard, timestamp) %>%
  separate(timestamp, into = c("dat","time"), sep=" ",
           remove = FALSE) %>%
  ggplot(aes(x = reorder(location, hr),
             fill=cardtype)) + 
  geom_bar_interactive(aes(tooltip = time),
                       width=0.5) + 
  facet_grid(ccard~day, scale = 'free') +
  scale_fill_manual(values=c("#1569C7", "orange", "green"))+
  scale_y_continuous(breaks=seq(0,2,1)) +
  labs(title =  expression(underline(
    "Transaction Timestamp at Locations for Credit Card No.")),
       y="No. of Transaction",
       x="",
       fill="Card Type") + 
  theme_classic()+ 
  theme(axis.text.x = element_text(size=7,angle=90, vjust= 0.9),
        axis.text.y = element_text(size=6),
        axis.title.y = element_text(size=6),
        panel.grid.minor = element_blank(),
        legend.direction="vertical",
        legend.title = element_text(color = "blue", size = 8),
        legend.background = element_rect(fill = "light yellow"),
        legend.text=element_text(size=7),
        legend.key = element_rect(size = 0.5),
        legend.key.size = unit(0.8, 'lines'),
        plot.title = element_text(size=10,hjust = 0.5,face="bold")
        )
gg <- girafe(ggobj=g, width_svg = 8, height_svg=8*0.618)
gg <- girafe_options(gg, opts_tooltip(opacity = .9,
                                    offx = 20, offy = -10, 
                                    use_fill = TRUE,
                                    use_stroke = TRUE,
                                    delay_mouseout = 1000) )
gg
```

```{r echo=FALSE}
# filter and grouping code chuck for timevis
visfull_ds <- full_ds %>% filter(id %in% c("9551","1")) %>% 
  mutate(group = id) %>%
  rename(content=location, start=timestamp, cid = id ) %>%
  filter(!is.na(start))

vis_gp <- visfull_ds%>% dplyr::select(group,cid) %>%
 rename(id = group, content = cid) %>%
  group_by(id,content) %>%
  summarise(count=n())

timevis::timevis(data = visfull_ds, groups=vis_gp,
                 height="400px", width = "700px")
```

2. __Visit to Unknown Locations__. Good to understand where were the locations terms with "Near" that vehicle ID 13 (card 7819 security), 15 (card 3853 security), 21 (card 9405 security) and 24 (card 4434 security) tend to visit during lunch time even at time on Saturday which activities deemed to be low. 

```{r, echo=FALSE} 

g <- mgps %>%
  filter (loctype=="Unknown") %>%
  group_by(id,trip) %>%
  mutate(location=last(location),
         loctype=last(loctype),
         timestamp=last(timestamp)) %>%
  separate(timestamp, into = c("date", "time"),
           sep=" ", remove = TRUE) %>%
  separate(date, into = c("yr","mth","day"), 
           sep="-",remove = TRUE) %>%
  arrange(id,trip) %>%
  ggplot(aes(x=day, y=location, fill=location)) +
  geom_tile_interactive(aes(tooltip = time, data_id = location),
                        colour="white", width=0.5)+
  facet_grid(id~.,scale="free")+
  labs(title = "Visit to Unknown Locations by Veh ID (Facet).",
       y="",
       x="Day",
       fill="Location") + 
  theme_minimal()+ 
  theme(axis.text.x = element_text(size=6),
        axis.text.y = element_text(size=0),
        axis.title.y = element_text(size=6),
        panel.grid.minor = element_blank(),
        legend.direction="vertical",
        legend.title = element_text(color = "blue", size = 8),
        legend.background = element_rect(fill = "light yellow"),
        legend.text=element_text(size=7),
        legend.key = element_rect(size = 0.5),
        legend.key.size = unit(0.8, 'lines'),
        plot.title = element_text(size=10,hjust = 0.5,face="bold")
        )

gg <- girafe(ggobj=g, width_svg = 8, height_svg=8*0.618)
gg <- girafe_options(gg, opts_tooltip(opacity = .9,
                                    offx = 20, offy = -10,
                                    use_fill = TRUE,
                                    use_stroke = TRUE,
                                    delay_mouseout = 1000) )
gg
```

In addition, check on Abila Park where vehicle id 25 (card 2142,security) parked his vehicle on 18 Jan 1245pm and collected only on 1230pm on 19 Jan. 

```{r}
# filter and grouping code chuck for timevis
visfull_ds <- full_ds %>% filter(id %in% c("2142","25")) %>% 
  mutate(group = id) %>%
  rename(content=location, start=timestamp, cid = id ) %>%
  filter(!is.na(start))

vis_gp <- visfull_ds%>% dplyr::select(group,cid) %>%
  rename(id = group, content = cid) %>%
  group_by(id,content) %>%
  summarise(count=n())

timevis::timevis(data = visfull_ds, groups=vis_gp,
                 height="400px", width = "700px")

```
3. __Credit Card TimeStamp Error__. As in Section 6.1 and 6.2, investigation location like Kronos Mart, Coffee Shack, Jack's Magical Beans (ESV,COO), Bean There Done That (Engineering BF gathering) and Brewed Awakenings (CFO,CIO) on the timestamp error in credit card transaction to ensure it was not a foul play, which assessed to be low as the place served a very small group of regular GAStect personnel. 


```{r echo=FALSE}
g <- fjoin %>%
  filter (location=="Brewed Awakenings") %>% 
  ggplot(aes(x=day, fill=Department)) + 
  geom_bar_interactive(aes(tooltip = ccard)) +
  scale_y_continuous(breaks=seq(0,2,1)) +
  scale_x_continuous(breaks=seq(6,19,1)) + 
  labs(title = expression(underline(
    "Date of Transaction & Count at Brewed Awakenings with Facet(Credit Card No)")),
       y="No. of Transaction",
       x=" X Jan 2014",
       fill="Department") + 
  facet_grid(row = vars(ccard), scales="free_y", space="free_y")+  
  theme_classic()+ 
  theme(axis.text.x = element_text(size=6),
        axis.text.y = element_text(size=6),
        axis.title.x = element_text(size=8),
        axis.title.y = element_text(size=8),
        panel.grid.minor = element_blank(),
        legend.direction="vertical",
        legend.title = element_text(color = "blue", size = 8),
        legend.background = element_rect(fill = "light yellow"),
        legend.text=element_text(size=7),
        legend.key = element_rect(size = 0.5),
        legend.key.size = unit(0.8, 'lines'),
        plot.title = element_text(size=10,hjust = 0.5,face="bold"),
        strip.text.y = element_text(size = 6)
        )

gg <- girafe(ggobj=g, width_svg = 8, height_svg=8*0.618)
gg <- girafe_options(gg, opts_tooltip(opacity = .9,
                                 offx = 20, offy = -10,
                                 use_fill = TRUE, 
                                 use_stroke = TRUE,
                                 delay_mouseout = 1000))
gg
```

4. __Geospatial Tracking Error__ For vehicle 28 (card un-determine, Engineering) and 9 (card 1877 Engineering) as explained above. In additional for vehicle ID 29 (card 5921 / 3547, Facility GM) as in Section 6.2 for full day missing records on 11 and 19 Jan where transaction were critical to verify the ongoing investigation. 

5. __Desafio Golf Course__. Good to understand why credit card 5010 CEO has transaction only starting from 17 Jan and staying in hotel. Based on timestamp, his golf game on 19 Jan should be playing with the executive ESV (card 2463, vehicle ID 35). If he was overseas prior to that and given the rising concern on environmental issues cause by GASTech, the conversation topic if any  might be useful for the investigation. 

```{r echo =FALSE}
g <- fjoin %>%
  filter(ccard  %in% c("5010", "2463")) %>%
  arrange(ccard, timestamp) %>%
  separate(timestamp, into = c("dat","time"), sep=" ",
           remove = FALSE) %>%
  ggplot(aes(x = reorder(location, hr),
             fill=cardtype)) + 
  geom_bar_interactive(aes(tooltip = time),
                       width=0.5) + 
  facet_grid(ccard~day, scale = 'free') +
  scale_fill_manual(values=c("#1569C7", "orange", "green"))+
  scale_y_continuous(breaks=seq(0,2,1)) +
  labs(title =  expression(underline(
    "Transaction Timestamp at Locations for Credit Card No.")),
       y="No. of Transaction",
       x="",
       fill="Card Type") + 
  theme_classic()+ 
  theme(axis.text.x = element_text(size=7,angle=90, vjust= 0.9),
        axis.text.y = element_text(size=6),
        axis.title.y = element_text(size=6),
        panel.grid.minor = element_blank(),
        legend.direction="vertical",
        legend.title = element_text(color = "blue", size = 8),
        legend.background = element_rect(fill = "light yellow"),
        legend.text=element_text(size=7),
        legend.key = element_rect(size = 0.5),
        legend.key.size = unit(0.8, 'lines'),
        plot.title = element_text(size=10,hjust = 0.5,face="bold")
        )
gg <- girafe(ggobj=g, width_svg = 8, height_svg=8*0.618)
gg <- girafe_options(gg, opts_tooltip(opacity = .9,
                                    offx = 20, offy = -10, 
                                    use_fill = TRUE,
                                    use_stroke = TRUE,
                                    delay_mouseout = 1000) )
gg
```

6. __Visitation to Executive House__. Good to understand why security personnel was at the executive house over the night as seen in Section 6.4.2. 

7. __Possible Unplanned Routine Schedule__. The visiting to various industrial locations by 9614 via vehicle 101 on 10 Jan seemed to a deviation form the norm as normally no visit to the identify location via 101 on every Friday. Good to understand whether it was a deviation with approval. 

```{r, echo=FALSE} 

g <- mgps %>%
  filter (loctype=="Industry") %>%
  group_by(id,trip) %>%
  mutate(location=last(location),
         loctype=last(loctype),
         timestamp=last(timestamp)) %>%
  separate(timestamp, into = c("date", "time"),
           sep=" ", remove = TRUE) %>%
  separate(date, into = c("yr","mth","day"), 
           sep="-",remove = TRUE) %>%
  arrange(id,trip) %>%
  ggplot(aes(x=day, y=location, fill=location)) +
  geom_tile_interactive(aes(tooltip = time, data_id = location),
                        colour="white", width=0.5)+
  facet_grid(id~.,scale="free")+
  labs(title = "Visit to Unknown Locations by Veh ID (Facet).",
       y="",
       x="Day",
       fill="Location") + 
  theme_minimal()+ 
  theme(axis.text.x = element_text(size=6),
        axis.text.y = element_text(size=0),
        axis.title.y = element_text(size=6),
        panel.grid.minor = element_blank(),
        legend.direction="vertical",
        legend.title = element_text(color = "blue", size = 8),
        legend.background = element_rect(fill = "light yellow"),
        legend.text=element_text(size=7),
        legend.key = element_rect(size = 0.5),
        legend.key.size = unit(0.8, 'lines'),
        plot.title = element_text(size=10,hjust = 0.5,face="bold")
        )

gg <- girafe(ggobj=g, width_svg = 8, height_svg=8*0.618)
gg <- girafe_options(gg, opts_tooltip(opacity = .9,
                                    offx = 20, offy = -10,
                                    use_fill = TRUE,
                                    use_stroke = TRUE,
                                    delay_mouseout = 1000) )
gg
```

```{r echo =FALSE}
g <- fjoin %>%
  filter(ccard  %in% c("9614")) %>%
  arrange(ccard, timestamp) %>%
  separate(timestamp, into = c("dat","time"), sep=" ",
           remove = FALSE) %>%
  ggplot(aes(x = reorder(location, hr),
             fill=cardtype)) + 
  geom_bar_interactive(aes(tooltip = time),
                       width=0.5) + 
  facet_grid(ccard~day, scale = 'free') +
  scale_fill_manual(values=c("#1569C7", "orange", "green"))+
  scale_y_continuous(breaks=seq(0,2,1)) +
  labs(title =  expression(underline(
    "Transaction Timestamp at Locations for Credit Card No.")),
       y="No. of Transaction",
       x="",
       fill="Card Type") + 
  theme_classic()+ 
  theme(axis.text.x = element_text(size=7,angle=90, vjust= 0.9),
        axis.text.y = element_text(size=6),
        axis.title.y = element_text(size=6),
        panel.grid.minor = element_blank(),
        legend.direction="vertical",
        legend.title = element_text(color = "blue", size = 8),
        legend.background = element_rect(fill = "light yellow"),
        legend.text=element_text(size=7),
        legend.key = element_rect(size = 0.5),
        legend.key.size = unit(0.8, 'lines'),
        plot.title = element_text(size=10,hjust = 0.5,face="bold")
        )
gg <- girafe(ggobj=g, width_svg = 8, height_svg=8*0.618)
gg <- girafe_options(gg, opts_tooltip(opacity = .9,
                                    offx = 20, offy = -10, 
                                    use_fill = TRUE,
                                    use_stroke = TRUE,
                                    delay_mouseout = 1000) )
gg
```

8.  __Meeting at Coffee Cameleon on 17 Jan Morning __. Good to further explore on the mentioned meeting by vehicle ID 24( credit card 4434, Security) and 20 (credit card 6816 Security). The place for meet up was deemed as a deviation from the usual place they would good for breakfast. In fact, when verify the chart, it was the first time, they been to the place. So it was just a coincidence or a planned activity?  

```{r, echo=FALSE} 

g <- mgps %>%
  filter(loctype == "Transacted") %>%
  filter (id =="24"|id=="20") %>%
  group_by(id,trip) %>%
  mutate(location=last(location),
         loctype=last(loctype),
         timestamp=last(timestamp)) %>%
  separate(timestamp, into = c("date", "time"),
           sep=" ", remove = TRUE) %>%
  separate(date, into = c("yr","mth","day"), 
           sep="-",remove = TRUE) %>%
  arrange(id,trip) %>%
  ggplot(aes(x=day, y=location, fill=location)) +
  geom_tile_interactive(aes(tooltip = time, data_id = location),
                        colour="white", width=0.5)+
  facet_grid(id~.,scale="free")+
  labs(title = "Visit to Unknown Locations by Veh ID (Facet).",
       y="",
       x="Day",
       fill="Location") + 
  theme_minimal()+ 
  theme(axis.text.x = element_text(size=6),
        axis.text.y = element_text(size=0),
        axis.title.y = element_text(size=6),
        panel.grid.minor = element_blank(),
        legend.direction="vertical",
        legend.title = element_text(color = "blue", size = 8),
        legend.background = element_rect(fill = "light yellow"),
        legend.text=element_text(size=7),
        legend.key = element_rect(size = 0.5),
        legend.key.size = unit(0.8, 'lines'),
        plot.title = element_text(size=10,hjust = 0.5,face="bold")
        )

gg <- girafe(ggobj=g, width_svg = 8, height_svg=8*0.618)
gg <- girafe_options(gg, opts_tooltip(opacity = .9,
                                    offx = 20, offy = -10,
                                    use_fill = TRUE,
                                    use_stroke = TRUE,
                                    delay_mouseout = 1000) )
gg
```


# 7.0 Conclusion 

It was an interesting exploration given the limited R programming skillset one have. Most of the visualisation aid here was done base on filtering of parameters which could be implemented in Shinny when required. A interactive dashboard allow one the ease of filering and selecting the desire parameters would aid one in comprehening the situation and investigation. In the utlity of visNetwork,igraph etc, could also work on different community detection techniques to determine the forming of community within the GASTect personnel even thought bipartitle graoh in visIgraph already have some in buit community association. 
